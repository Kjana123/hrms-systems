<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRMS Attendance Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Moment.js for date handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <!-- Moment-timezone for timezone support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <!-- Axios for HTTP requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- jwt-decode for token decoding -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jwt-decode/3.1.2/jwt-decode.min.js"></script>
    <!-- FileSaver.js for saving files (used by saveAs) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Core React Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        /* Custom styles for buttons and elements */
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-success:hover:not(:disabled) {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-warning {
            background-color: #ffc107;
            color: #333;
            padding: 8px 16px;
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-warning:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            background-color: #ffc107;
            color: #333;
        }
        .btn-warning:hover:not(:disabled) {
            background-color: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
            padding: 8px 16px;
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-danger:hover:not(:disabled) {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 8px 16px;
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-dark-toggle {
            background-color: #4b5563;
            color: white;
            padding: 8px 16px;
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-dark-toggle:hover {
            background-color: #374151;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .tabs {
            padding: 10px 20px;
            border-radius: 0.5rem;
            background-color: #e5e7eb;
            color: #374151;
            font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tabs.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        .tabs:hover:not(.active) {
            background-color: #d1d5db;
            transform: translateY(-1px);
        }
        .card {
            background-color: white;
            padding: 24px;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        html.dark .card {
            background-color: #1f2937;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 9999px;
            margin-left: 8px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-badge-present {
            background-color: #10B981; /* Green-500 */
            color: white;
        }
        .status-badge-late {
            background-color: #EF4444; /* Red-500 */
            color: white;
        }
        .status-badge-checked-in {
            background-color: #3B82F6; /* Blue-500 */
            color: white;
        }
        .status-badge-approved {
            background-color: #059669; /* Emerald-600 */
            color: white;
        }
        .status-badge-pending {
            background-color: #FBBF24; /* Yellow-400 */
            color: #333;
        }
        .status-badge-rejected {
            background-color: #B91C1C; /* Red-700 */
            color: white;
        }
        .status-badge-cancellation-pending {
            background-color: #F59E0B; /* Orange-500 */
            color: white;
        }
        .status-badge-cancelled {
            background-color: #6B7280; /* Gray-500 */
            color: white;
            text-decoration: line-through;
        }
        .status-badge-absent {
            background-color: #4B5563; /* Gray-700 */
            color: white;
        }
        /* Custom scrollbar for overflow areas */
        .scrollbar-thin {
            scrollbar-width: thin; /* Firefox */
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px; /* For vertical scrollbar */
            height: 8px; /* For horizontal scrollbar */
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #9CA3AF; /* Gray-400 */
            border-radius: 4px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background-color: #F3F4F6; /* Gray-100 */
            border-radius: 4px;
        }
        html.dark .scrollbar-thin::-webkit-scrollbar-track {
            background-color: #374151; /* Gray-700 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        const API_URL = 'https://hrms-backend-rhsc.onrender.com';

        const axiosInstance = window.axios.create({ // Explicitly use window.axios
            baseURL: API_URL,
            withCredentials: true,
        });

        axiosInstance.interceptors.request.use(
            (config) => {
                const token = localStorage.getItem('accessToken');
                if (token) {
                    config.headers.Authorization = `Bearer ${token}`;
                }
                return config;
            },
            (error) => Promise.reject(error)
        );

        axiosInstance.interceptors.response.use(
            (response) => response,
            async (error) => {
                const originalRequest = error.config;
                if (error.response?.status === 401 && !originalRequest._retry) {
                    originalRequest._retry = true;
                    try {
                        console.log('Attempting to refresh token...');
                        const { data } = await axiosInstance.post('/auth/refresh');
                        console.log('Token refreshed successfully');
                        localStorage.setItem('accessToken', data.accessToken);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        originalRequest.headers.Authorization = `Bearer ${data.accessToken}`;
                        return axiosInstance(originalRequest);
                    } catch (refreshError) {
                        console.error('Refresh token failed definitively:', {
                            message: refreshError.message,
                            response: refreshError.response?.data,
                            status: refreshError.response?.status,
                        });
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('user');
                        window.location.replace('/');
                        return Promise.reject(refreshError);
                    }
                }
                console.error('API error:', {
                    url: error.config?.url,
                    status: error.response?.status,
                    message: error.response?.data?.message,
                });
                return Promise.reject(error);
            }
        );

        const AuthForms = ({ authView, setToken, setUser, setRole, darkMode, toggleDarkMode }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [newPassword, setNewPassword] = useState(''); // Only for reset password

            const handleLogin = async (e) => {
                e.preventDefault();
                try {
                    const res = await axiosInstance.post('/auth/login', { email, password });
                    localStorage.setItem('accessToken', res.data.accessToken);
                    localStorage.setItem('user', JSON.stringify(res.data.user));
                    setToken(res.data.accessToken);
                    setUser(res.data.user);
                    setRole(res.data.user.role);
                    alert('Login successful!');
                } catch (err) {
                    alert('Login failed: ' + (err.response?.data?.message || err.message));
                }
            };

            const handleResetPassword = async (e) => {
                e.preventDefault();
                try {
                    // Use window.axios explicitly
                    await window.axios.post(`${API_URL}/auth/reset-password`, { token: new URLSearchParams(window.location.search).get('token'), newPassword });
                    alert('Password reset successful! Please login.');
                    window.location.href = '/';
                } catch (err) {
                    alert('Reset password failed: ' + (err.response?.data?.message || err.message));
                }
            };

            return (
                <div className={`min-h-screen flex items-center justify-center p-4 ${darkMode ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-900'}`}>
                    <div className="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-xl transform transition-all duration-300 hover:shadow-3xl">
                        <div className="flex justify-end mb-4">
                            <button
                                onClick={toggleDarkMode}
                                className="text-sm text-blue-500 hover:text-blue-600 transition-colors duration-200 font-medium"
                            >
                                Toggle {darkMode ? 'Light' : 'Dark'} Mode
                            </button>
                        </div>
                        {authView === 'login' ? (
                            <>
                                <h2 className="text-3xl font-bold mb-6 text-center text-gray-800 dark:text-white">Welcome Back</h2>
                                <form onSubmit={handleLogin} className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Email</label>
                                        <input
                                            type="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                            placeholder="Enter your email"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Password</label>
                                        <input
                                            type="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                            placeholder="Enter your password"
                                            required
                                        />
                                    </div>
                                    <button
                                        type="submit"
                                        className="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700 transition-all duration-200 font-semibold"
                                    >
                                        Sign In
                                    </button>
                                </form>
                                <p className="mt-4 text-center text-sm text-gray-600 dark:text-gray-400">
                                    Need an account? Please contact your administrator.
                                </p>
                                <p className="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">
                                    Forgot your password?{' '}
                                    <a href="/?view=resetPassword" className="text-blue-500 hover:text-blue-600 font-medium transition-colors duration-200">
                                        Reset it here
                                    </a>
                                </p>
                            </>
                        ) : ( /* authView === 'resetPassword' */
                            <>
                                <h2 className="text-3xl font-bold mb-6 text-center text-gray-800 dark:text-white">Reset Password</h2>
                                <form onSubmit={handleResetPassword} className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">New Password</label>
                                        <input
                                            type="password"
                                            value={newPassword}
                                            onChange={(e) => setNewPassword(e.target.value)}
                                            className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                            required
                                        />
                                    </div>
                                    <button
                                        type="submit"
                                        className="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 focus:ring-4 focus:ring-300 dark:focus:ring-blue-700 transition-all duration-200 font-semibold"
                                    >
                                        Reset Password
                                    </button>
                                </form>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const LeaveApplicationForm = ({ onApplyLeave, darkMode }) => {
            const [fromDate, setFromDate] = useState('');
            const [toDate, setToDate] = useState('');
            const [reason, setReason] = useState('');
            const [totalDays, setTotalDays] = useState(0);

            useEffect(() => {
                if (fromDate && toDate) {
                    const start = window.moment(fromDate); // Use window.moment
                    const end = window.moment(toDate);     // Use window.moment
                    if (end.isSameOrAfter(start)) {
                        setTotalDays(end.diff(start, 'days') + 1);
                    } else {
                        setTotalDays(0);
                    }
                } else {
                    setTotalDays(0);
                }
            }, [fromDate, toDate]);

            const handleSubmit = useCallback((e) => {
                e.preventDefault();
                if (totalDays <= 0) {
                    alert('Please select a valid leave duration (To Date must be on or after From Date).');
                    return;
                }
                onApplyLeave(fromDate, toDate, reason);
                setFromDate('');
                setToDate('');
                setReason('');
                setTotalDays(0);
            }, [fromDate, toDate, reason, onApplyLeave, totalDays]);

            return (
                <form onSubmit={handleSubmit} className="mb-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium mb-1">From Date</label>
                            <input
                                type="date"
                                value={fromDate}
                                onChange={(e) => setFromDate(e.target.value)}
                                className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">To Date</label>
                            <input
                                type="date"
                                value={toDate}
                                onChange={(e) => setToDate(e.target.value)}
                                className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                required
                            />
                        </div>
                    </div>
                    {totalDays > 0 && (
                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                            Total days of leave: <span className="font-semibold">{totalDays}</span>
                        </p>
                    )}
                    <div className="mb-4">
                        <label className="block text-sm font-medium mb-1">Reason</label>
                        <textarea
                            value={reason}
                            onChange={(e) => setReason(e.target.value)}
                            className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                            rows="4"
                            required
                        />
                    </div>
                    <button type="submit" className="bg-green-500 text-white p-2 rounded hover:bg-green-600">
                        Apply Leave
                    </button>
                </form>
            );
        };

        const AdminPanel = ({ allLeaves, allCorrections, handleLeaveApproval, handleCorrectionApproval, allEmployeeAttendance, fetchAllEmployeeAttendance, monthlySummary, fetchAllEmployeeMonthlySummary, darkMode, handleExportAttendance, handleAddEmployee }) => {
            const [selectedDate, setSelectedDate] = useState(window.moment().tz('Asia/Kolkata').format('YYYY-MM-DD')); // Use window.moment
            const [selectedAnalyticsYear, setSelectedAnalyticsYear] = useState(window.moment().tz('Asia/Kolkata').year()); // Use window.moment
            const [selectedAnalyticsMonth, setSelectedAnalyticsMonth] = useState(window.moment().tz('Asia/Kolkata').month() + 1); // Use window.moment
            const [exportYear, setExportYear] = useState(window.moment().tz('Asia/Kolkata').year()); // Use window.moment
            const [exportMonth, setExportMonth] = useState(window.moment().tz('Asia/Kolkata').month() + 1); // Use window.moment
            const [exportEmployeeId, setExportEmployeeId] = useState('');
            const [exportEmployeeName, setExportEmployeeName] = useState('');

            // State for Add Employee form
            const [newEmployeeName, setNewEmployeeName] = useState('');
            const [newEmployeeEmail, setNewEmployeeEmail] = useState('');
            const [newEmployeePassword, setNewEmployeePassword] = useState('');
            const [newEmployeeId, setNewEmployeeId] = useState('');
            const [newEmployeeRole, setNewEmployeeRole] = useState('employee');
            const [newEmployeeShiftType, setNewEmployeeShiftType] = useState('day');


            useEffect(() => {
                fetchAllEmployeeAttendance(selectedDate);
            }, [selectedDate, fetchAllEmployeeAttendance]);

            useEffect(() => {
                fetchAllEmployeeMonthlySummary(selectedAnalyticsYear, selectedAnalyticsMonth);
            }, [selectedAnalyticsYear, selectedAnalyticsMonth, fetchAllEmployeeMonthlySummary]);

            const handleAddEmployeeSubmit = useCallback(async (e) => {
                e.preventDefault();
                handleAddEmployee(newEmployeeName, newEmployeeEmail, newEmployeePassword, newEmployeeId, newEmployeeRole, newEmployeeShiftType);
                setNewEmployeeName('');
                setNewEmployeeEmail('');
                setNewEmployeePassword('');
                setNewEmployeeId('');
                setNewEmployeeRole('employee');
                setNewEmployeeShiftType('day');
            }, [newEmployeeName, newEmployeeEmail, newEmployeePassword, newEmployeeId, newEmployeeRole, newEmployeeShiftType, handleAddEmployee]);


            return (
                <div>
                    <h2 className="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Add New Employee</h2>
                    <form onSubmit={handleAddEmployeeSubmit} className="space-y-4 mb-8 p-6 bg-gray-50 dark:bg-gray-750 rounded-lg shadow-inner">
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Name:</label>
                            <input type="text" value={newEmployeeName} onChange={(e) => setNewEmployeeName(e.target.value)}
                                className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Email:</label>
                            <input type="email" value={newEmployeeEmail} onChange={(e) => setNewEmployeeEmail(e.target.value)}
                                className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Temporary Password:</label>
                            <input type="password" value={newEmployeePassword} onChange={(e) => setNewEmployeePassword(e.target.value)}
                                className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Employee ID:</label>
                            <input type="text" value={newEmployeeId} onChange={(e) => setNewEmployeeId(e.target.value)}
                                className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Role:</label>
                            <select value={newEmployeeRole} onChange={(e) => setNewEmployeeRole(e.target.value)}
                                className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                                <option value="employee">Employee</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Shift Type:</label>
                            <select value={newEmployeeShiftType} onChange={(e) => setNewEmployeeShiftType(e.target.value)}
                                className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                                <option value="day">Day</option>
                                <option value="evening">Evening</option>
                            </select>
                        </div>
                        <button type="submit" className="btn-primary w-full py-3">Add Employee</button>
                    </form>

                    <h3 className="text-lg mb-3 text-gray-800 dark:text-gray-100">Manage Leaves</h3>
                    <ul className="list-disc pl-5 space-y-2 mb-6 max-h-48 overflow-y-auto scrollbar-thin">
                        {allLeaves.length > 0 ? (
                            allLeaves.map((l, i) => (
                                <li key={i} className="py-1 flex justify-between items-center text-sm text-gray-700 dark:text-gray-300">
                                    <span>
                                        <strong>{l.user_name} ({l.employee_id || 'N/A'})</strong> applied for leave: {window.moment(l.from_date).tz('Asia/Kolkata').format('YYYY-MM-DD')} to {window.moment(l.to_date).tz('Asia/Kolkata').format('YYYY-MM-DD')} - {l.reason}
                                        <span className={`status-badge status-badge-${l.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`}>
                                            [{l.status}]
                                        </span>
                                        {l.assigned_admin_name && <span className="ml-2 text-gray-500 dark:text-gray-400"> (Assigned to: {l.assigned_admin_name})</span>}
                                    </span>
                                    {l.status === 'pending' && (
                                        <div>
                                            <button
                                                onClick={() => handleLeaveApproval(l.id, 'approved')}
                                                className="bg-green-500 text-white px-2 py-1 rounded-md mr-2 hover:bg-green-600 transition-colors"
                                            >
                                                Approve
                                            </button>
                                            <button
                                                onClick={() => handleLeaveApproval(l.id, 'rejected')}
                                                className="bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 transition-colors"
                                            >
                                                Reject
                                            </button>
                                        </div>
                                    )}
                                    {l.status === 'cancellation_pending' && (
                                        <div>
                                            <button
                                                onClick={() => handleLeaveApproval(l.id, 'cancellation_approved')}
                                                className="bg-yellow-500 text-white px-2 py-1 rounded-md mr-2 hover:bg-yellow-600 transition-colors"
                                            >
                                                Approve Cancellation
                                            </button>
                                            <button
                                                onClick={() => handleLeaveApproval(l.id, 'cancellation_rejected')}
                                                className="bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 transition-colors"
                                            >
                                                Reject Cancellation
                                            </button>
                                        </div>
                                    )}
                                </li>
                            ))
                        ) : (
                            <p className="text-gray-600 dark:text-gray-400">No leave requests found.</p>
                        )}
                    </ul>
                    <h3 className="text-lg mb-3 text-gray-800 dark:text-gray-100">Manage Correction Requests</h3>
                    <ul className="list-disc pl-5 space-y-2 max-h-48 overflow-y-auto scrollbar-thin">
                        {allCorrections.length > 0 ? (
                            allCorrections.map((c, i) => (
                                <li key={i} className="py-1 flex justify-between items-center text-sm text-gray-700 dark:text-gray-300">
                                    <span>
                                        <strong>{c.user_name} ({c.employee_id || 'N/A'})</strong> requested correction for: {window.moment(c.date).tz('Asia/Kolkata').format('YYYY-MM-DD')} - {c.reason}
                                        <span className={`status-badge status-badge-${c.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`}>
                                            [{c.status}]
                                        </span>
                                        {c.assigned_admin_name && <span className="ml-2 text-gray-500 dark:text-gray-400"> (Assigned to: {c.assigned_admin_name})</span>}
                                    </span>
                                    {c.status === 'pending' && (
                                        <div>
                                            <button
                                                onClick={() => handleCorrectionApproval(c.id, 'approved')}
                                                className="bg-green-500 text-white px-2 py-1 rounded-md mr-2 hover:bg-green-600 transition-colors"
                                            >
                                                Approve
                                            </button>
                                            <button
                                                onClick={() => handleCorrectionApproval(c.id, 'rejected')}
                                                className="bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 transition-colors"
                                            >
                                                Reject
                                            </button>
                                        </div>
                                    )}
                                </li>
                            ))
                        ) : (
                            <p className="text-gray-600 dark:text-gray-400">No correction requests found.</p>
                        )}
                    </ul>

                    <h3 className="text-lg mt-6 mb-3 text-gray-800 dark:text-gray-100">Daily Employee Attendance Overview</h3>
                    <div className="mb-4">
                        <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Select Date:</label>
                        <input
                            type="date"
                            value={selectedDate}
                            onChange={(e) => setSelectedDate(e.target.value)}
                            className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                        />
                    </div>
                    <div className="overflow-x-auto rounded-lg shadow-md">
                        <table className="min-w-full bg-white dark:bg-gray-800 text-sm">
                            <thead className="bg-blue-600 dark:bg-blue-800 text-white">
                                <tr>
                                    <th className="px-6 py-3 text-left font-semibold">Employee Name</th>
                                    <th className="px-6 py-3 text-left font-semibold">Employee ID</th>
                                    <th className="px-6 py-3 text-left font-semibold">Shift Type</th>
                                    <th className="px-6 py-3 text-left font-semibold">Status</th>
                                    <th className="px-6 py-3 text-left font-semibold">Check-in</th>
                                    <th className="px-6 py-3 text-left font-semibold">Check-out</th>
                                </tr>
                            </thead>
                            <tbody>
                                {allEmployeeAttendance.length > 0 ? (
                                    allEmployeeAttendance.map((emp, index) => (
                                        <tr key={emp.user_id} className={index % 2 === 0 ? 'bg-gray-50 dark:bg-gray-750' : 'bg-white dark:bg-gray-800'}>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.name}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.employee_id}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.shift_type}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className={`status-badge status-badge-${emp.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`}>
                                                    {emp.status || 'N/A'}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.check_in ? window.moment(emp.check_in, 'HH:mm:ss').format('HH:mm') : 'N/A'}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.check_out ? window.moment(emp.check_out, 'HH:mm:ss').format('HH:mm') : 'N/A'}</td>
                                        </tr>
                                    ))
                                ) : (
                                    <tr>
                                        <td colSpan="6" className="px-6 py-4 text-center text-gray-600 dark:text-gray-400">No employee attendance data found for this date.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>

                    <h3 className="text-lg mt-6 mb-3 text-gray-800 dark:text-gray-100">Monthly Employee Summary</h3>
                    <div className="flex space-x-4 mb-4">
                        <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Year:</label>
                        <input
                            type="number"
                            value={selectedAnalyticsYear}
                            onChange={(e) => setSelectedAnalyticsYear(parseInt(e.target.value, 10))}
                            className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white w-24"
                            min="2000"
                            max="2099"
                        />
                        <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Month:</label>
                        <input
                            type="number"
                            value={selectedAnalyticsMonth}
                            onChange={(e) => setSelectedAnalyticsMonth(parseInt(e.target.value, 10))}
                            className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white w-24"
                            min="1"
                            max="12"
                        />
                    </div>
                    <div className="overflow-x-auto rounded-lg shadow-md">
                        <table className="min-w-full bg-white dark:bg-gray-800 text-sm">
                            <thead className="bg-blue-600 dark:bg-blue-800 text-white">
                                <tr>
                                    <th className="px-6 py-3 text-left font-semibold">Employee Name</th>
                                    <th className="px-6 py-3 text-left font-semibold">Employee ID</th>
                                    <th className="px-6 py-3 text-left font-semibold">Present Days</th>
                                    <th className="px-6 py-3 text-left font-semibold">Leave Days</th>
                                </tr>
                            </thead>
                            <tbody>
                                {monthlySummary.length > 0 ? (
                                    monthlySummary.map((emp, index) => (
                                        <tr key={emp.user_id} className={index % 2 === 0 ? 'bg-gray-50 dark:bg-gray-750' : 'bg-white dark:bg-gray-800'}>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.name}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.employee_id}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.present_days}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.leave_days}</td>
                                        </tr>
                                    ))
                                ) : (
                                    <tr>
                                        <td colSpan="4" className="px-6 py-4 text-center text-gray-600 dark:text-gray-400">No monthly summary data found for the selected period.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>

                    <h3 className="text-lg mt-6 mb-3 text-gray-800 dark:text-gray-100">Export Attendance Data</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label htmlFor="exportYear" className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Year:</label>
                            <input
                                type="number"
                                value={exportYear}
                                onChange={(e) => setExportYear(parseInt(e.target.value, 10))}
                                placeholder="Year (e.g., 2025)"
                                className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                id="exportYear"
                                min="2000"
                                max="2099"
                            />
                        </div>
                        <div>
                            <label htmlFor="exportMonth" className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Month:</label>
                            <input
                                type="number"
                                value={exportMonth}
                                onChange={(e) => setExportMonth(parseInt(e.target.value, 10))}
                                placeholder="Month (1-12)"
                                className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                id="exportMonth"
                                min="1"
                                max="12"
                            />
                        </div>
                        <div>
                            <label htmlFor="exportEmployeeId" className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Employee ID (Optional):</label>
                            <input
                                type="text"
                                placeholder="Employee ID"
                                className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                value={exportEmployeeId}
                                onChange={(e) => setExportEmployeeId(e.target.value)}
                                id="exportEmployeeId"
                            />
                        </div>
                        <div>
                            <label htmlFor="exportEmployeeName" className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Employee Name (Optional):</label>
                            <input
                                type="text"
                                placeholder="Employee Name"
                                className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                value={exportEmployeeName}
                                onChange={(e) => setExportEmployeeName(e.target.value)}
                                id="exportEmployeeName"
                            />
                        </div>
                    </div>
                    <button
                        onClick={() => {
                            if (exportYear && exportMonth) {
                                // Use window.saveAs from FileSaver.js CDN
                                window.saveAs(new Blob([""], {type: "text/csv"}), `attendance_${exportYear}_${exportMonth}.csv`); // Placeholder
                                handleExportAttendance(exportYear, exportMonth, exportEmployeeId, exportEmployeeName);
                            } else {
                                alert('Please enter year and month.');
                            }
                        }}
                        className="btn-primary rounded-md px-4 py-2 hover:shadow-lg transition-shadow duration-200"
                    >
                        Download CSV
                    </button>
                </div>
            );
        };

        const ChangePasswordModal = ({ onClose, onChangePassword, darkMode }) => {
            const [currentPassword, setCurrentPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');

            const handleSubmit = useCallback((e) => {
                e.preventDefault();
                onChangePassword(currentPassword, newPassword);
                setCurrentPassword('');
                setNewPassword('');
            }, [currentPassword, newPassword, onChangePassword]);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className={`bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-sm ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        <h2 className="text-xl font-bold mb-4">Change Password</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-1">Current Password</label>
                                <input
                                    type="password"
                                    value={currentPassword}
                                    onChange={(e) => setCurrentPassword(e.target.value)}
                                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                    required
                                />
                            </div>
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-1">New Password</label>
                                <input
                                    type="password"
                                    value={newPassword}
                                    onChange={(e) => setNewPassword(e.target.value)}
                                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                    required
                                />
                            </div>
                            <div className="flex justify-end space-x-2">
                                <button type="button" onClick={onClose} className="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition-colors">
                                    Cancel
                                </button>
                                <button type="submit" className="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition-colors">
                                    Change Password
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const CorrectionRequestModal = ({ onClose, onSubmit, darkMode }) => {
            const [date, setDate] = useState('');
            const [reason, setReason] = useState('');

            const handleSubmit = useCallback((e) => {
                e.preventDefault();
                onSubmit(date, reason);
                setDate('');
                setReason('');
            }, [date, reason, onSubmit]);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className={`bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-sm ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        <h2 className="text-xl font-bold mb-4">Request Attendance Correction</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-1">Date</label>
                                <input
                                    type="date"
                                    value={date}
                                    onChange={(e) => setDate(e.target.value)}
                                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    required
                                />
                            </div>
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-1">Reason</label>
                                <textarea
                                    value={reason}
                                    onChange={(e) => setReason(e.target.value)}
                                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                    rows="4"
                                    required
                                />
                            </div>
                            <div className="flex justify-end space-x-2">
                                <button type="button" onClick={onClose} className="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition-colors">
                                    Cancel
                                </button>
                                <button type="submit" className="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition-colors">
                                    Submit
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const CancelLeaveModal = ({ onClose, onConfirmCancel, leaveId, darkMode }) => {
            const handleConfirm = useCallback(() => {
                onConfirmCancel(leaveId);
                onClose();
            }, [onConfirmCancel, leaveId, onClose]);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className={`bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-xs ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        <h2 className="text-xl font-bold mb-4">Confirm Cancellation</h2>
                        <p className="mb-6">Are you sure you want to request cancellation for this leave?</p>
                        <div className="flex justify-end space-x-2">
                            <button type="button" onClick={onClose} className="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition-colors">
                                No, Keep It
                            </button>
                            <button type="button" onClick={handleConfirm} className="bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition-colors">
                                Yes, Request Cancellation
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [token, setToken] = useState(localStorage.getItem('accessToken'));
            const [role, setRole] = useState(null);
            const [tab, setTab] = useState('attendance');
            const [attendance, setAttendance] = useState([]);
            const [leaves, setLeaves] = useState([]);
            const [holidays, setHolidays] = useState([]);
            const [corrections, setCorrections] = useState([]);
            const [darkMode, setDarkMode] = useState(() => {
                const savedMode = localStorage.getItem('darkMode');
                if (savedMode) {
                    return JSON.parse(savedMode);
                }
                return window.matchMedia('(prefers-color-scheme: dark)').matches;
            });
            const [showChangePasswordModal, setShowChangePasswordModal] = useState(false);
            const [showCorrectionRequestModal, setShowCorrectionRequestModal] = useState(false);
            const [showCancelLeaveModal, setShowCancelLeaveModal] = useState(false);
            const [selectedLeaveToCancel, setSelectedLeaveToCancel] = useState(null);
            const [allLeaves, setAllLeaves] = useState([]);
            const [allCorrections, setAllCorrections] = useState([]);
            const [allEmployeeAttendance, setAllEmployeeAttendance] = useState([]);
            const [monthlySummary, setMonthlySummary] = useState([]);
            const [today, setToday] = useState(window.moment().tz('Asia/Kolkata').format('YYYY-MM-DD'));
            const [user, setUser] = useState(null);
            const [todayAttendance, setTodayAttendance] = useState(null);
            const [isCheckingIn, setIsCheckingIn] = useState(false);
            const [analytics, setAnalytics] = useState({
                presentDays: 0,
                weeklyOffs: 0,
                leavesTaken: 0,
                holidays: 0
            });
            const [selectedMonthForTable, setSelectedMonthForTable] = useState(window.moment().tz('Asia/Kolkata').format('YYYY-MM'));
            const [overallStats, setOverallStats] = useState({ totalEmployees: 'Loading...', totalAdmins: 'Loading...', pendingLeaves: 'Loading...', pendingCorrections: 'Loading...' });


            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                localStorage.setItem('darkMode', JSON.stringify(darkMode));
            }, [darkMode]);

            const handleLogout = useCallback(async () => {
                try {
                    await axiosInstance.post('/auth/logout');
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('user');
                    setToken(null);
                    setUser(null);
                    setRole(null);
                    setTodayAttendance(null);
                    setAttendance([]);
                    setLeaves([]);
                    setCorrections([]);
                    setAllLeaves([]);
                    setAllCorrections([]);
                    setAllEmployeeAttendance([]);
                    setMonthlySummary([]);
                    setHolidays([]);
                    setTab('attendance');
                    setAnalytics({ presentDays: 0, weeklyOffs: 0, leavesTaken: 0, holidays: 0 });
                    alert('Logged out successfully!');
                } catch (err) {
                    console.error('Logout failed:', err);
                    alert('Logout failed: ' + (err.response?.data?.message || err.message));
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('user');
                    setToken(null);
                    setUser(null);
                    setRole(null);
                }
            }, []);

            const fetchAttendance = useCallback(async () => {
                try {
                    const res = await axiosInstance.get(`/attendance`);
                    console.log('Fetched attendance data:', res.data);
                    setAttendance(res.data);
                } catch (err) {
                    console.error('Error fetching attendance:', err);
                    if (err.response?.status === 401) handleLogout();
                }
            }, [handleLogout]);

            const fetchLeaves = useCallback(async () => {
                try {
                    const { data } = await axiosInstance.get('/leaves');
                    setLeaves(data);
                } catch (error) {
                    console.error('Error fetching leaves:', error);
                    if (error.response?.status === 401) handleLogout();
                }
            }, [handleLogout]);

            const fetchHolidays = useCallback(async () => {
                try {
                    const { data } = await axiosInstance.get('/holidays');
                    setHolidays(data);
                }
                catch (error) {
                    console.error('Error fetching holidays:', error);
                    if (error.response?.status === 404) {
                        console.warn('Holidays endpoint not found; using empty holidays list.');
                        setHolidays([]);
                    } else if (error.response?.status === 401) {
                        handleLogout();
                    }
                }
            }, [handleLogout]);

            const fetchCorrections = useCallback(async () => {
                try {
                    const { data } = await axiosInstance.get('/attendance/corrections/user', {
                        withCredentials: true,
                    });
                    console.log('Fetched corrections data:', data);
                    setCorrections(data);
                } catch (error) {
                    console.error('Error fetching corrections:', {
                        message: error.message,
                        status: error.response?.status,
                        data: error.response?.data,
                        url: error.config?.url,
                    });
                    if (error.response?.status === 401) handleLogout();
                }
            }, [handleLogout]);

            const fetchAllAdminLeaves = useCallback(async () => {
                if (user?.role === 'admin') {
                    try {
                        const { data } = await axiosInstance.get('/admin/leaves');
                        setAllLeaves(data);
                    }
                    catch (error) {
                        console.error('Error fetching all admin leaves:', error);
                        if (error.response?.status === 401) handleLogout();
                    }
                }
            }, [user?.role, handleLogout]);

            const fetchAllAdminCorrections = useCallback(async () => {
                if (user?.role === 'admin') {
                    try {
                        const { data } = await axiosInstance.get('/admin/attendance/corrections');
                        setAllCorrections(data);
                    }
                    catch (error) {
                        console.error('Error fetching all admin corrections:', error);
                        if (error.response?.status === 401) handleLogout();
                    }
                }
            }, [user?.role, handleLogout]);

            const fetchAllEmployeeAttendance = useCallback(async (date) => {
                if (user?.role === 'admin') {
                    try {
                        const { data } = await axiosInstance.get(`/admin/attendance/daily?date=${date}`);
                        setAllEmployeeAttendance(data);
                    }
                    catch (error) {
                        console.error('Error fetching all employee daily attendance:', error);
                        if (error.response?.status === 401) handleLogout();
                    }
                }
            }, [user?.role, handleLogout]);

            const fetchAllEmployeeMonthlySummary = useCallback(async (year, month) => {
                if (user?.role === 'admin') {
                    try {
                        const { data } = await axiosInstance.get(`/admin/analytics/monthly-summary?year=${year}&month=${month}`);
                        setMonthlySummary(data);
                    }
                    catch (error) {
                        console.error('Error fetching all employee monthly summary:', error);
                        if (error.response?.status === 401) handleLogout();
                    }
                }
            }, [user?.role, handleLogout]);

            const fetchOverallStats = useCallback(async () => {
                if (user?.role === 'admin') {
                    try {
                        // These endpoints are assumed to exist on the backend for analytics
                        // You might need to implement these on your Node.js server
                        const { data: employeesData } = await axiosInstance.get('/admin/employees/count'); // Example: { total_employees: X, total_admins: Y }
                        const { data: pendingLeavesData } = await axiosInstance.get('/admin/leaves/pending-count'); // Example: { pending_leaves: Z }
                        const { data: pendingCorrectionsData } = await axiosInstance.get('/admin/corrections/pending-count'); // Example: { pending_corrections: A }

                        setOverallStats({
                            totalEmployees: employeesData.total_employees || 0,
                            totalAdmins: employeesData.total_admins || 0,
                            pendingLeaves: pendingLeavesData.pending_leaves || 0,
                            pendingCorrections: pendingCorrectionsData.pending_corrections || 0,
                        });
                    } catch (error) {
                        console.error('Error fetching overall stats:', error);
                        // Handle 404 specifically if endpoints don't exist yet gracefully
                        if (error.response?.status === 404) {
                            console.warn("Analytics endpoints not found. Overall stats will not be displayed.");
                        } else if (error.response?.status === 401) {
                            handleLogout();
                        }
                        setOverallStats({ totalEmployees: 'N/A', totalAdmins: 'N/A', pendingLeaves: 'N/A', pendingCorrections: 'N/A' });
                    }
                }
            }, [user?.role, handleLogout]);

            const fetchAllAdminData = useCallback(async () => {
                await Promise.all([
                    fetchAllAdminLeaves(),
                    fetchAllAdminCorrections(),
                    fetchAllEmployeeMonthlySummary(window.moment().tz('Asia/Kolkata').year(), window.moment().tz('Asia/Kolkata').month() + 1),
                    fetchOverallStats() // Fetch overall stats for admin dashboard
                ]);
            }, [fetchAllAdminLeaves, fetchAllAdminCorrections, fetchAllEmployeeMonthlySummary, fetchOverallStats]);

            const refreshUserData = useCallback(async () => {
                if (isCheckingIn) {
                    console.log('Skipping refreshUserData during check-in');
                    return;
                }
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) {
                    console.warn('No access token found, skipping attendance fetch and clearing user state.');
                    setUser(null);
                    setRole(null);
                    return;
                }
                try {
                    const todayFormatted = window.moment().tz('Asia/Kolkata').format('YYYY-MM-DD');
                    console.log('Refreshing data for date:', todayFormatted);

                    const res = await axiosInstance.get('/attendance');
                    const allRecords = res.data;
                    console.log('Fetched attendance records:', allRecords);
                    const todayRecord = allRecords.find(a => window.moment(a.date).tz('Asia/Kolkata').format('YYYY-MM-DD') === todayFormatted);
                    console.log('Today\'s attendance record:', todayRecord);
                    setAttendance(allRecords);
                    setTodayAttendance(todayRecord || null);

                    await Promise.all([fetchLeaves(), fetchCorrections(), fetchHolidays()]);
                } catch (error) {
                    console.error('Failed to fetch user data or attendance:', {
                        message: error.message,
                        status: error.response?.status,
                        url: error.config?.url,
                    });
                    if (error.response?.status === 401) {
                        console.warn('Unauthorized during data refresh, logging out.');
                        handleLogout();
                    }
                    setTodayAttendance(null);
                }
            }, [isCheckingIn, fetchLeaves, fetchCorrections, fetchHolidays, handleLogout]);

            const updateAnalytics = useCallback(() => {
                const startOfMonth = window.moment().tz('Asia/Kolkata').startOf('month');
                const endOfMonth = window.moment().tz('Asia/Kolkata').endOf('month');
                let presentDays = 0;
                let weeklyOffs = 0;
                let leavesTaken = 0;
                let holidaysCount = 0;

                presentDays = attendance.filter(a =>
                    window.moment(a.date).tz('Asia/Kolkata').isBetween(startOfMonth, endOfMonth, null, '[]') &&
                    a.status && ['present', 'late'].includes(a.status.toLowerCase())
                ).length;

                let currentDay = startOfMonth.clone();
                while (currentDay.isSameOrBefore(endOfMonth)) {
                    if (currentDay.day() === 0 || currentDay.day() === 6) {
                        const hasAttendance = attendance.some(a =>
                            window.moment(a.date).tz('Asia/Kolkata').format('YYYY-MM-DD') === currentDay.format('YYYY-MM-DD')
                        );
                        if (!hasAttendance) weeklyOffs++;
                    }
                    currentDay.add(1, 'day');
                }

                leaves.filter(l => l.status === 'approved').forEach(l => {
                    const leaveStart = window.moment(l.from_date).tz('Asia/Kolkata');
                    const leaveEnd = window.moment(l.to_date).tz('Asia/Kolkata');

                    const effectiveStart = window.moment.max(leaveStart, startOfMonth);
                    const effectiveEnd = window.moment.min(leaveEnd, endOfMonth);

                    if (effectiveStart.isSameOrBefore(effectiveEnd)) {
                        leavesTaken += effectiveEnd.diff(effectiveStart, 'days') + 1;
                    }
                });

                holidaysCount = holidays.filter(h =>
                    window.moment(h.date).tz('Asia/Kolkata').isBetween(startOfMonth, endOfMonth, null, '[]')
                ).length;

                setAnalytics({
                    presentDays,
                    weeklyOffs,
                    leavesTaken,
                    holidays: holidaysCount
                });
            }, [attendance, leaves, holidays]);

            useEffect(() => {
                updateAnalytics();
            }, [attendance, leaves, holidays, updateAnalytics]);

            useEffect(() => {
                const storedUser = localStorage.getItem('user');
                const storedAccessToken = localStorage.getItem('accessToken');
                if (storedUser && storedAccessToken) {
                    try {
                        // Use window.jwt_decode
                        const decodedToken = window.jwt_decode(storedAccessToken);
                        // Make sure the token is still valid. If it's expired, force a refresh or logout.
                        if (decodedToken.exp * 1000 < Date.now()) {
                            console.warn('Access token expired on load, attempting refresh or logging out.');
                            handleLogout(); // Try logging out to trigger refresh logic if needed
                            return;
                        }

                        const parsedUser = JSON.parse(storedUser);
                        console.log('App.jsx: Loaded user from localStorage (parsed):', parsedUser);
                        setUser(parsedUser);
                        setRole(parsedUser.role);
                        setToken(storedAccessToken);
                        console.log('App.jsx: User state SET from localStorage:', parsedUser.name);
                    } catch (error) {
                        console.error("App.jsx: Failed to parse user data from localStorage or decode token:", error);
                        localStorage.removeItem('user');
                        localStorage.removeItem('accessToken');
                        setUser(null);
                        setRole(null);
                        setToken(null);
                    }
                } else {
                    console.log('App.jsx: No user data or token found in localStorage.');
                    setUser(null);
                    setRole(null);
                    setToken(null);
                }
            }, []); // Empty dependency array to run only once on component mount

            useEffect(() => {
                if (token && user) {
                    refreshUserData();
                    if (user.role === 'admin') {
                        fetchAllAdminData();
                        fetchAllEmployeeAttendance(window.moment().tz('Asia/Kolkata').format('YYYY-MM-DD'));
                        fetchAllEmployeeMonthlySummary(window.moment().tz('Asia/Kolkata').year(), window.moment().tz('Asia/Kolkata').month() + 1);
                    }
                } else if (!token && !user) {
                    setTodayAttendance(null);
                    setAttendance([]);
                    setLeaves([]);
                    setCorrections([]);
                    setAllLeaves([]);
                    setAllCorrections([]);
                    setAllEmployeeAttendance([]);
                    setMonthlySummary([]);
                    setHolidays([]);
                    setAnalytics({ presentDays: 0, weeklyOffs: 0, leavesTaken: 0, holidays: 0 });
                }
            }, [token, user, refreshUserData, fetchAllAdminData, fetchAllEmployeeAttendance, fetchAllEmployeeMonthlySummary]);

            useEffect(() => {
                console.log(' Updated todayAttendance:', todayAttendance);
            }, [todayAttendance]);

            useEffect(() => {
                const interval = setInterval(() => {
                    const newToday = window.moment().tz('Asia/Kolkata').format('YYYY-MM-DD');
                    if (newToday !== today) {
                        console.log('Date changed, refreshing data:', newToday);
                        setToday(newToday);
                        setTodayAttendance(null);
                        refreshUserData();
                        if (user?.role === 'admin') {
                            fetchAllEmployeeAttendance(newToday);
                            fetchAllEmployeeMonthlySummary(window.moment().tz('Asia/Kolkata').year(), window.moment().tz('Asia/Kolkata').month() + 1);
                        }
                    }
                }, 60000);
                return () => clearInterval(interval);
            }, [today, refreshUserData, user?.role, fetchAllEmployeeAttendance, fetchAllEmployeeMonthlySummary]);

            const handleCheckIn = useCallback(async () => {
                try {
                    setIsCheckingIn(true);
                    const response = await axiosInstance.post('/attendance/checkin');
                    alert(`Checked in successfully! Status: ${response.data.data.status}`);
                    setTodayAttendance({
                        ...response.data.data,
                        date: window.moment(response.data.data.date).tz('Asia/Kolkata').format('YYYY-MM-DD')
                    });
                    await refreshUserData();
                } catch (err) {
                    console.error('Check-in failed:', err);
                    alert('Check-in failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                } finally {
                    setIsCheckingIn(false);
                }
            }, [refreshUserData, handleLogout]);

            const handleCheckOut = useCallback(async () => {
                try {
                    setIsCheckingIn(true);
                    const response = await axiosInstance.post('/attendance/checkout');
                    alert('Checked out successfully!');
                    setTodayAttendance({
                        ...response.data.data,
                        date: window.moment(response.data.data.date).tz('Asia/Kolkata').format('YYYY-MM-DD')
                    });
                    await refreshUserData();
                } catch (err) {
                    console.error('Check-out failed:', err);
                    alert('Check-out failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                } finally {
                    setIsCheckingIn(false);
                }
            }, [refreshUserData, handleLogout]);

            const handleExportAttendance = useCallback(async (year, month, employeeId = '', employeeName = '') => {
                try {
                    const params = { year, month };
                    let filenameSuffix = '';

                    if (employeeId) {
                        params.employee_id = employeeId;
                        filenameSuffix = `_${employeeId}`;
                    } else if (employeeName) {
                        params.employee_name = employeeName;
                        filenameSuffix = `_${employeeName.replace(/\s/g, '_')}`;
                    }

                    const response = await axiosInstance.get('/admin/attendance/export', {
                        params: params,
                        responseType: 'blob'
                    });
                    // Use window.saveAs from FileSaver.js CDN
                    window.saveAs(new Blob([response.data], { type: 'text/csv' }), `attendance_${year}_${month}${filenameSuffix}.csv`);
                    alert('Attendance data exported successfully!');
                } catch (err) {
                    console.error('Export failed:', err);
                    alert('Export failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                }
            }, [handleLogout]);

            const handleAddEmployee = useCallback(async (name, email, password, employee_id, role, shift_type) => {
                try {
                    // This endpoint needs to be secured on the backend to only allow 'admin' role to register users
                    const res = await axiosInstance.post('/admin/register-employee', { name, email, password, employee_id, role, shift_type });
                    alert(`Employee ${name} registered successfully!`);
                    // Optionally refresh admin data to show new employee in lists if needed
                    if (user?.role === 'admin') {
                        fetchAllAdminData();
                    }
                } catch (err) {
                    console.error('Employee registration failed:', err);
                    alert('Employee registration failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                }
            }, [user?.role, fetchAllAdminData, handleLogout]);


            const refreshAdminData = useCallback(async () => {
                await Promise.all([
                    fetchAllAdminLeaves(),
                    fetchAllAdminCorrections(),
                    fetchAllEmployeeAttendance(window.moment().tz('Asia/Kolkata').format('YYYY-MM-DD')),
                    fetchAllEmployeeMonthlySummary(window.moment().tz('Asia/Kolkata').year(), window.moment().tz('Asia/Kolkata').month() + 1),
                    fetchOverallStats()
                ]);
            }, [fetchAllAdminLeaves, fetchAllAdminCorrections, fetchAllEmployeeAttendance, fetchAllEmployeeMonthlySummary, fetchOverallStats]);

            const handleCorrectionRequest = useCallback(async (date, reason) => {
                try {
                    if (window.moment(date).isAfter(window.moment().tz('Asia/Kolkata'), 'day')) {
                        alert('Attendance correction can only be requested for past or current dates.');
                        return;
                    }
                    await axiosInstance.post('/attendance/correction-request', { date, reason });
                    alert('Correction request submitted!');
                    await refreshUserData();
                    if (user?.role === 'admin') {
                        await fetchAllAdminCorrections();
                    }
                    setShowCorrectionRequestModal(false);
                } catch (err) {
                    console.error('Correction request failed:', err);
                    alert('Correction request failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                }
            }, [refreshUserData, handleLogout, user?.role, fetchAllAdminCorrections]);

            const handleCorrectionApproval = useCallback(async (id, status) => {
                try {
                    await axiosInstance.post('/admin/attendance/correction-review', { id, status });
                    alert(`Correction ID ${id} ${status}!`);
                    await refreshAdminData();
                    await refreshUserData();
                } catch (err) {
                    console.error('Correction review failed:', err);
                    alert('Correction review failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                }
            }, [refreshAdminData, refreshUserData, handleLogout]);

            const handleLeaveApproval = useCallback(async (leave_id, status) => {
                try {
                    if (status === 'approved' || status === 'rejected') {
                        await axiosInstance.post('/admin/leaves/update', { leave_id, status });
                        alert(`Leave ID ${leave_id} ${status}!`);
                    } else if (status === 'cancellation_approved' || status === 'cancellation_rejected') {
                        await axiosInstance.post('/admin/leaves/update-cancellation', { leave_id, status });
                        alert(`Leave ID ${leave_id} cancellation ${status.replace('cancellation_', '')}!`);
                    } else {
                        alert('Invalid leave status provided.');
                        return;
                    }
                    await refreshAdminData();
                    await refreshUserData();
                } catch (err) {
                    console.error('Leave update failed:', err);
                    alert('Leave update failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                }
            }, [refreshAdminData, refreshUserData, handleLogout]);

            const handleApplyLeave = useCallback(async (from_date, to_date, reason) => {
                try {
                    console.log('Submitting leave application:', { from_date, to_date, reason });
                    await axiosInstance.post('/leaves/apply', { from_date, to_date, reason });
                    alert('Leave application submitted!');
                    await refreshUserData();
                } catch (err) {
                    console.error('Leave application failed:', err);
                    alert('Leave application failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                }
            }, [refreshUserData, handleLogout]);

            const handleCancelLeaveRequest = useCallback(async (leaveId) => {
                try {
                    console.log(`Requesting cancellation for leave ID: ${leaveId}`);
                    await axiosInstance.post('/leaves/cancel-request', { leave_id: leaveId });
                    alert('Leave cancellation request submitted successfully!');
                    await refreshUserData();
                    setShowCancelLeaveModal(false);
                    setSelectedLeaveToCancel(null);
                } catch (err) {
                    console.error('Leave cancellation request failed:', err);
                    alert('Leave cancellation request failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                } finally {
                    setShowCancelLeaveModal(false);
                    setSelectedLeaveToCancel(null);
                }
            }, [refreshUserData, handleLogout]);

            const handleChangePassword = useCallback(async (currentPassword, newPassword) => {
                try {
                    const res = await axiosInstance.post('/auth/change-password', { currentPassword, newPassword });
                    alert(res.data.message);
                    setShowChangePasswordModal(false);
                } catch (err) {
                    console.error('Change password failed:', err.response?.data?.message || err.message);
                    alert('Change password failed: ' + (err.response?.data?.message || 'Please check your current password.'));
                    if (err.response?.status === 401) handleLogout();
                }
            }, [handleLogout]);

            const toggleDarkMode = useCallback(() => setDarkMode(prev => !prev), []);

            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('token');
            // Modified AuthForms to remove register option for employees
            const authView = resetToken
                ? 'resetPassword'
                : 'login';

            const userMonthlyAttendance = useMemo(() => {
                const data = [];
                const [year, month] = selectedMonthForTable.split('-').map(Number);
                const startOfMonth = window.moment().tz('Asia/Kolkata').year(year).month(month - 1).startOf('month');
                const endOfMonth = window.moment().tz('Asia/Kolkata').year(year).month(month - 1).endOf('month');
                
                let currentDay = startOfMonth.clone();
                while (currentDay.isSameOrBefore(endOfMonth)) {
                    const dateFormatted = currentDay.format('YYYY-MM-DD');
                    const dayOfWeek = currentDay.format('dddd');
                    let status = 'Absent';
                    let checkIn = 'N/A';
                    let checkOut = 'N/A';
                    let lateTime = '0h 0m'; // Initialize as hours and minutes
                    let workingHours = '0h 0m';
                    let extraHours = '0h 0m';
                    let rowClass = '';

                    const attendanceRecord = attendance.find(a => window.moment(a.date).tz('Asia/Kolkata').format('YYYY-MM-DD') === dateFormatted);
                    const leaveRecord = leaves.find(l =>
                        l.status === 'approved' &&
                        window.moment(dateFormatted).isBetween(window.moment(l.from_date).tz('Asia/Kolkata'), window.moment(l.to_date).tz('Asia/Kolkata'), null, '[]')
                    );
                    const holidayRecord = holidays.find(h => window.moment(h.date).tz('Asia/Kolkata').format('YYYY-MM-DD') === dateFormatted);

                    if (holidayRecord) {
                        status = `Holiday: ${holidayRecord.name}`;
                        rowClass = 'bg-purple-100 dark:bg-purple-800';
                    } else if (leaveRecord) {
                        status = `On Leave: ${leaveRecord.reason}`;
                        rowClass = 'bg-yellow-100 dark:bg-yellow-800';
                    } else if (currentDay.day() === 0 || currentDay.day() === 6) {
                        status = 'Weekly Off (WO)';
                        rowClass = 'bg-blue-100 dark:bg-blue-800';
                    }

                    if (attendanceRecord) {
                        checkIn = attendanceRecord.check_in ? window.moment(attendanceRecord.check_in, 'HH:mm:ss').format('HH:mm A') : 'N/A';
                        checkOut = attendanceRecord.check_out ? window.moment(attendanceRecord.check_out, 'HH:mm:ss').format('HH:mm A') : 'N/A';
                        status = attendanceRecord.status === 'present' ? 'Present' : (attendanceRecord.status === 'late' ? 'Late' : attendanceRecord.status);
                        rowClass = attendanceRecord.status === 'late' ? 'bg-red-100 dark:bg-red-800' : (status === 'present' ? 'bg-green-100 dark:bg-green-800' : rowClass);

                        if (attendanceRecord.check_in) {
                            // Determine expected check-in time based on shift type
                            const expectedCheckinTime = user?.shift_type === 'evening'
                                ? window.moment(dateFormatted).tz('Asia/Kolkata').hour(21).minute(0).second(0) // 9 PM IST
                                : window.moment(dateFormatted).tz('Asia/Kolkata').hour(9).minute(0).second(0);   // 9 AM IST

                            const actualCheckIn = window.moment(attendanceRecord.check_in, 'HH:mm:ss').tz('Asia/Kolkata').date(currentDay.date()).month(currentDay.month()).year(currentDay.year());

                            if (actualCheckIn.isAfter(expectedCheckinTime)) {
                                const diffMinutes = actualCheckIn.diff(expectedCheckinTime, 'minutes');
                                if (diffMinutes > 0) {
                                    const lateHours = Math.floor(diffMinutes / 60);
                                    const lateMins = diffMinutes % 60;
                                    lateTime = `${lateHours}h ${lateMins}m`;
                                }
                            }
                        }

                        if (attendanceRecord.check_in && attendanceRecord.check_out) {
                            const checkInMoment = window.moment(attendanceRecord.check_in, 'HH:mm:ss');
                            const checkOutMoment = window.moment(attendanceRecord.check_out, 'HH:mm:ss');

                            let totalDuration = window.moment.duration(checkOutMoment.diff(checkInMoment));
                            // Handle overnight shifts for evening shift
                            if (user?.shift_type === 'evening' && checkInMoment.isAfter(checkOutMoment)) {
                                totalDuration = window.moment.duration(checkOutMoment.add(1, 'day').diff(checkInMoment));
                            } else if (checkInMoment.isAfter(checkOutMoment)) {
                                // If check-in is after check-out for day shift, something is wrong, assume 0 working hours
                                totalDuration = window.moment.duration(0);
                            }

                            const standardWorkingHours = 8 * 60; // 8 hours in minutes
                            let totalMinutes = totalDuration.asMinutes();
                            let calculatedWorkingHours = Math.floor(totalMinutes / 60);
                            let calculatedWorkingMinutes = Math.round(totalMinutes % 60);

                            workingHours = `${calculatedWorkingHours}h ${calculatedWorkingMinutes}m`;

                            if (totalMinutes > standardWorkingHours) {
                                const extraMinutes = totalMinutes - standardWorkingHours;
                                extraHours = `${Math.floor(extraMinutes / 60)}h ${Math.round(extraMinutes % 60)}m`;
                            }
                        }
                    }

                    data.push({
                        date: dateFormatted,
                        dayOfWeek,
                        shift: user?.shift_type || 'N/A',
                        checkIn,
                        checkOut,
                        lateTime,
                        workingHours,
                        extraHours,
                        status,
                        rowClass,
                    });
                    currentDay.add(1, 'day');
                }
                return data;
            }, [selectedMonthForTable, attendance, leaves, holidays, user]);


            if (!token) {
                // If the URL has /?view=register, redirect to login as self-registration is disabled
                if (window.location.search.includes('view=register')) {
                    window.location.replace('/');
                }
                return <AuthForms authView={authView} setToken={setToken} setUser={setUser} setRole={setRole} darkMode={darkMode} toggleDarkMode={toggleDarkMode} />;
            }

            return (
                <div className={`min-h-screen font-sans ${darkMode ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-900'} p-6 transition-colors duration-300`}>
                    <div className="max-w-7xl mx-auto text-center py-8">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-10 p-4 bg-gradient-to-r from-blue-500 to-purple-600 dark:from-blue-800 dark:to-purple-900 text-white rounded-xl shadow-lg">
                            <div>
                                <h1 className="text-4xl font-extrabold mb-2 leading-tight">
                                     Welcome to HRMS, {user?.name || 'User'}!
                                </h1>
                                <p className="text-xl font-light opacity-90">
                                    You are logged in as <span className="font-semibold">{role}</span>. Shift: <span className="font-semibold">{user?.shift_type || 'day'}</span> {user?.employee_id && `(Employee ID: ${user.employee_id})`}
                                </p>
                            </div>
                            <div className="flex space-x-3 mt-4 md:mt-0">
                                <button
                                    onClick={() => setShowChangePasswordModal(true)}
                                    className="bg-white text-blue-600 px-5 py-2 rounded-lg shadow-md hover:bg-blue-50 transition-all duration-200 font-semibold"
                                >
                                    Change Password
                                </button>
                                <button
                                    onClick={handleLogout}
                                    className="bg-red-400 text-white px-5 py-2 rounded-lg shadow-md hover:bg-red-500 transition-all duration-200 font-semibold"
                                >
                                    Logout
                                </button>
                            </div>
                        </div>

                        <button
                            onClick={toggleDarkMode}
                            className="btn-dark-toggle mb-8 text-lg"
                        >
                            Toggle {darkMode ? 'Light' : 'Dark'} Mode
                        </button>

                        <div className="flex flex-wrap justify-center space-x-3 mb-8">
                            <button
                                onClick={() => setTab('attendance')}
                                className={`tabs ${tab === 'attendance' ? 'active' : ''}`}
                            >
                                Attendance
                            </button>
                            <button
                                onClick={() => setTab('leaves')}
                                className={`tabs ${tab === 'leaves' ? 'active' : ''}`}
                            >
                                Leaves
                            </button>
                            {/* Calendar Tab Removed */}
                            <button
                                onClick={() => setTab('analytics')}
                                className={`tabs ${tab === 'analytics' ? 'active' : ''}`}
                            >
                                Analytics
                            </button>
                            {role === 'admin' && (
                                <button
                                    onClick={() => { setTab('admin'); refreshAdminData(); }}
                                    className={`tabs ${tab === 'admin' ? 'active' : ''}`}
                                >
                                    Admin Panel
                                </button>
                            )}
                        </div>

                        {console.log(" todayAttendance:", todayAttendance)}
                        {tab === 'attendance' && (
                            <div className="card text-left">
                                <h2 className="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Attendance Actions</h2>
                                <p className="mb-6 text-lg font-medium text-gray-700 dark:text-gray-300">
                                    Expected check-in: {user?.shift_type === 'evening' ? '9:00 PM IST' : '9:00 AM IST'}
                                </p>
                                <div className="flex space-x-4 mb-8 flex-wrap gap-y-3">
                                    <button
                                        onClick={handleCheckIn}
                                        className="btn-success text-lg flex-1 md:flex-none"
                                        disabled={!!todayAttendance?.check_in || isCheckingIn}
                                    >
                                        {todayAttendance?.check_in ? 'Already Checked In' : 'Check In'}
                                    </button>
                                    <button
                                        onClick={handleCheckOut}
                                        className="btn-warning text-lg flex-1 md:flex-none"
                                        disabled={
                                            !todayAttendance ||
                                            todayAttendance.check_in === null ||
                                            todayAttendance.check_out !== null ||
                                            isCheckingIn
                                        }
                                        title={
                                            !todayAttendance?.check_in
                                                ? "You must check in before checking out."
                                                : todayAttendance?.check_out
                                                    ? "You have already checked out today."
                                                    : ""
                                        }
                                    >
                                        Check Out
                                    </button>
                                </div>

                                <h3 className="text-xl font-semibold mt-8 mb-4 text-gray-800 dark:text-gray-100">Monthly Attendance Overview</h3>
                                <div className="mb-6">
                                    <label htmlFor="monthPicker" className="block text-md font-medium mb-2 text-gray-700 dark:text-gray-300">Select Month:</label>
                                    <input
                                        type="month"
                                        id="monthPicker"
                                        value={selectedMonthForTable}
                                        onChange={(e) => setSelectedMonthForTable(e.target.value)}
                                        className="p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition-all"
                                    />
                                </div>
                                <div className="overflow-x-auto rounded-xl shadow-lg">
                                    <table className="min-w-full bg-white dark:bg-gray-800 text-sm">
                                        <thead className="bg-blue-600 dark:bg-blue-800 text-white">
                                            <tr>
                                                <th className="px-6 py-3 text-left font-semibold">Date</th>
                                                <th className="px-6 py-3 text-left font-semibold">Day</th>
                                                <th className="px-6 py-3 text-left font-semibold">Shift</th>
                                                <th className="px-6 py-3 text-left font-semibold">Check-in</th>
                                                <th className="px-6 py-3 text-left font-semibold">Check-out</th>
                                                <th className="px-6 py-3 text-left font-semibold">Late Time</th>
                                                <th className="px-6 py-3 text-left font-semibold">Working Hours</th>
                                                <th className="px-6 py-3 text-left font-semibold">Extra Hours</th>
                                                <th className="px-6 py-3 text-left font-semibold">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {userMonthlyAttendance.length > 0 ? (
                                                userMonthlyAttendance.map((day, index) => (
                                                    <tr key={day.date} className={`${index % 2 === 0 ? 'bg-gray-50 dark:bg-gray-750' : 'bg-white dark:bg-gray-800'} ${day.rowClass} hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150`}>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.date}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.dayOfWeek}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.shift}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.checkIn}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.checkOut}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.lateTime}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.workingHours}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.extraHours}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap">
                                                            <span className={`status-badge status-badge-${day.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`}>
                                                                {day.status}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))
                                            ) : (
                                                <tr>
                                                    <td colSpan="9" className="px-6 py-4 text-center text-gray-600 dark:text-gray-400">No attendance data found for this month.</td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>

                                <h3 className="text-xl font-semibold mt-8 mb-4 text-gray-800 dark:text-gray-100">Request Attendance Correction</h3>
                                <button
                                    onClick={() => setShowCorrectionRequestModal(true)}
                                    className="btn-secondary text-lg px-6 py-3 rounded-md hover:shadow-lg transition-shadow duration-200"
                                >
                                    Request Correction
                                </button>

                                <h3 className="text-xl font-semibold mt-8 mb-4 text-gray-800 dark:text-gray-100">Your Correction Requests History</h3>
                                <ul className="list-disc pl-5 space-y-3 scrollbar-thin max-h-96 overflow-y-auto pr-2">
                                    {corrections.length > 0 ? (
                                        corrections.map((c, idx) => (
                                            <li key={idx} className="py-2 text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-gray-700 last:border-b-0">
                                                <span className="font-medium">{window.moment(c.date).tz('Asia/Kolkata').format('YYYY-MM-DD')}</span>: {c.reason}
                                                <span className={`status-badge status-badge-${c.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`}>
                                                    [{c.status}]
                                                </span>
                                            </li>
                                        ))
                                    ) : (
                                        <p className="text-gray-600 dark:text-gray-400">No correction requests found.</p>
                                    )}
                                </ul>
                            </div>
                        )}

                        {tab === 'leaves' && (
                            <div className="card text-left">
                                <h2 className="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Apply for Leave</h2>
                                <LeaveApplicationForm onApplyLeave={handleApplyLeave} darkMode={darkMode} />
                                <h3 className="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Your Leave Applications</h3>
                                <ul className="list-disc pl-5 space-y-3 scrollbar-thin max-h-96 overflow-y-auto pr-2">
                                    {leaves.length > 0 ? (
                                        leaves.map((l, i) => {
                                            const isFutureApprovedLeave = l.status === 'approved' && window.moment(l.from_date).isAfter(window.moment().tz('Asia/Kolkata'), 'day');
                                            return (
                                                <li key={i} className="py-2 flex flex-col sm:flex-row justify-between items-start sm:items-center text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-gray-700 last:border-b-0">
                                                    <span className="mb-2 sm:mb-0">
                                                        <span className="font-medium">{window.moment(l.from_date).tz('Asia/Kolkata').format('YYYY-MM-DD')} to {window.moment(l.to_date).tz('Asia/Kolkata').format('YYYY-MM-DD')}</span>: {l.reason}
                                                        <span className={`status-badge status-badge-${l.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`}>
                                                            [{l.status}]
                                                        </span>
                                                    </span>
                                                    {isFutureApprovedLeave && (
                                                        <button
                                                            onClick={() => {
                                                                setSelectedLeaveToCancel(l.id);
                                                                setShowCancelLeaveModal(true);
                                                            }}
                                                            className="bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600 text-sm transition-colors duration-200"
                                                        >
                                                            Request Cancellation
                                                        </button>
                                                    )}
                                                </li>
                                            );
                                        })
                                    ) : (
                                        <p className="text-gray-600 dark:text-gray-400">No leave applications found.</p>
                                    )}
                                </ul>
                            </div>
                        )}

                        {tab === 'analytics' && (
                            <div className="card text-left">
                                <h2 className="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Monthly Attendance Analytics</h2>
                                <p className="mb-6 text-lg font-medium text-gray-700 dark:text-gray-300">For {window.moment(selectedMonthForTable).tz('Asia/Kolkata').format('MMMM YYYY')}</p>
                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    <div className="bg-green-100 dark:bg-green-900/40 p-4 rounded-lg shadow-md flex flex-col items-center">
                                        <span className="text-3xl font-bold text-green-700 dark:text-green-300">{analytics.presentDays}</span>
                                        <span className="text-sm mt-1 text-gray-700 dark:text-gray-300">Days Present</span>
                                    </div>
                                    <div className="bg-blue-100 dark:bg-blue-900/40 p-4 rounded-lg shadow-md flex flex-col items-center">
                                        <span className="text-3xl font-bold text-blue-700 dark:text-blue-300">{analytics.weeklyOffs}</span>
                                        <span className="text-sm mt-1 text-gray-700 dark:text-gray-300">Weekly Offs</span>
                                    </div>
                                    <div className="bg-yellow-100 dark:bg-yellow-900/40 p-4 rounded-lg shadow-md flex flex-col items-center">
                                        <span className="text-3xl font-bold text-yellow-700 dark:text-yellow-300">{analytics.leavesTaken}</span>
                                        <span className="text-sm mt-1 text-gray-700 dark:text-gray-300">Leaves Taken</span>
                                    </div>
                                    <div className="bg-purple-100 dark:bg-purple-900/40 p-4 rounded-lg shadow-md flex flex-col items-center">
                                        <span className="text-3xl font-bold text-purple-700 dark:text-purple-300">{analytics.holidays}</span>
                                        <span className="text-sm mt-1 text-gray-700 dark:text-gray-300">Holidays</span>
                                    </div>
                                </div>
                            </div>
                        )}

                        {role === 'admin' && tab === 'admin' && (
                            <div className="card text-left">
                                <h2 className="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Admin Panel Overview</h2>

                                {/* Overall HRMS Statistics */}
                                <div className="mb-8 p-6 bg-blue-50 dark:bg-blue-900/40 rounded-lg shadow-inner">
                                    <h3 className="text-xl font-semibold mb-4 text-blue-800 dark:text-blue-200">Overall HRMS Statistics</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-gray-800 dark:text-gray-200">
                                        <div className="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md flex flex-col items-center">
                                            <span className="text-4xl font-bold text-blue-600 dark:text-blue-400">{overallStats.totalEmployees}</span>
                                            <span className="text-sm mt-1">Total Employees</span>
                                        </div>
                                        <div className="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md flex flex-col items-center">
                                            <span className="text-4xl font-bold text-green-600 dark:text-green-400">{overallStats.totalAdmins}</span>
                                            <span className="text-sm mt-1">Total Admins</span>
                                        </div>
                                        <div className="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md flex flex-col items-center">
                                            <span className="text-4xl font-bold text-yellow-600 dark:text-yellow-400">{overallStats.pendingLeaves}</span>
                                            <span className="text-sm mt-1">Pending Leaves</span>
                                        </div>
                                        <div className="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md flex flex-col items-center">
                                            <span className="text-4xl font-bold text-red-600 dark:text-red-400">{overallStats.pendingCorrections}</span>
                                            <span className="text-sm mt-1">Pending Corrections</span>
                                        </div>
                                    </div>
                                    <p className="text-xs text-gray-600 dark:text-gray-400 mt-4 text-center">
                                        (Note: Overall statistics require backend API endpoints for `/admin/employees/count`, `/admin/leaves/pending-count`, and `/admin/corrections/pending-count` to be fully functional.)
                                    </p>
                                </div>


                                <AdminPanel
                                    allLeaves={allLeaves}
                                    allCorrections={allCorrections}
                                    handleLeaveApproval={handleLeaveApproval}
                                    handleCorrectionApproval={handleCorrectionApproval}
                                    allEmployeeAttendance={allEmployeeAttendance}
                                    fetchAllEmployeeAttendance={fetchAllEmployeeAttendance}
                                    monthlySummary={monthlySummary}
                                    fetchAllEmployeeMonthlySummary={fetchAllEmployeeMonthlySummary}
                                    darkMode={darkMode}
                                    handleExportAttendance={handleExportAttendance}
                                    handleAddEmployee={handleAddEmployee}
                                />
                            </div>
                        )}

                        {showChangePasswordModal && (
                            <ChangePasswordModal
                                onClose={() => setShowChangePasswordModal(false)}
                                onChangePassword={handleChangePassword}
                                darkMode={darkMode}
                            />
                        )}

                        {showCorrectionRequestModal && (
                            <CorrectionRequestModal
                                onClose={() => setShowCorrectionRequestModal(false)}
                                onSubmit={handleCorrectionRequest}
                                darkMode={darkMode}
                            />
                        )}

                        {showCancelLeaveModal && (
                            <CancelLeaveModal
                                onClose={() => {
                                    setShowCancelLeaveModal(false);
                                    setSelectedLeaveToCancel(null);
                                }}
                                onConfirmCancel={handleCancelLeaveRequest}
                                leaveId={selectedLeaveToCancel}
                                darkMode={darkMode}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // Defer rendering until window is fully loaded to ensure all CDNs are ready
        window.onload = function() {
            console.log("window.onload fired. Attempting to render React App.");

            // Set default timezone for moment
            if (window.moment && typeof window.moment.tz === 'function') {
                window.moment.tz.setDefault('Asia/Kolkata');
                console.log("Moment.js and Moment-timezone configured.");
            } else {
                console.error("Error: Moment.js or Moment-timezone not fully loaded or configured. Please check CDN links and network status.");
                document.getElementById('root').innerHTML = '<div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; font-family: \'Inter\', sans-serif; background-color: #f3f4f6; color: #ef4444; font-size: 1.25rem; text-align: center; padding: 20px;">' +
                                        'Error: Date library not loaded. Please ensure your internet connection is stable and try again.' +
                                        '</div>';
                return; // Stop execution if critical library is missing
            }

            // Explicitly check for React and ReactDOM global objects
            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                console.error("Error: React or ReactDOM not loaded. Please check CDN links and network status.");
                document.getElementById('root').innerHTML = '<div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; font-family: \'Inter\', sans-serif; background-color: #f3f4f6; color: #ef4444; font-size: 1.25rem; text-align: center; padding: 20px;">' +
                                        'Error: Core application libraries (React/ReactDOM) not loaded. <br/> Please ensure your internet connection is stable and try again.' +
                                        '</div>';
                return; // Stop execution if critical library is missing
            }
            console.log("React and ReactDOM are available.");

            // Ensure Axios is available
            if (typeof window.axios === 'undefined') {
                console.error("Error: Axios CDN not loaded. Please check CDN link for Axios.");
                document.getElementById('root').innerHTML = '<div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; font-family: \'Inter\', sans-serif; background-color: #f3f4f6; color: #ef4444; font-size: 1.25rem; text-align: center; padding: 20px;">' +
                                        'Error: Network library (Axios) not loaded. <br/> Please ensure your internet connection is stable and try again.' +
                                        '</div>';
                return; // Stop execution if critical library is missing
            }
            console.log("Axios is available.");

            // jwt-decode check (less critical for initial render but important for functionality)
            if (typeof window.jwt_decode === 'undefined') {
                 console.warn("Warning: jwt-decode CDN not loaded. Some token decoding functionality might be impaired. Please check CDN link for jwt-decode.");
            } else {
                console.log("jwt-decode is available.");
            }
            // FileSaver.js check
            if (typeof window.saveAs === 'undefined') {
                console.warn("Warning: FileSaver.js CDN not loaded. CSV export functionality might be impaired. Please check CDN link for FileSaver.js.");
            } else {
                console.log("FileSaver.js is available.");
            }


            // Now render the App
            try {
                ReactDOM.render(<App />, document.getElementById('root'));
                console.log("React App rendered successfully into #root.");
            } catch (e) {
                console.error("Error rendering React App:", e);
                document.getElementById('root').innerHTML = `<div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #ef4444; font-size: 1.25rem; text-align: center; padding: 20px;">` +
                                        `Application failed to start: ${e.message}. <br/> Please check your browser's developer console for more details.` +
                                        `</div>`;
            }
        };
    </script>
</body>
</html>
