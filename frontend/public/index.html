<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRMS Attendance Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- React, ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Axios for API calls -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Moment.js and Moment-timezone -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
    <!-- React Big Calendar CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/react-big-calendar/1.12.0/css/react-big-calendar.min.css" />
    <!-- React Big Calendar JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-big-calendar/1.12.0/react-big-calendar.min.js"></script>
    <!-- Removed: Drag and Drop Addon JS as it caused issues in this setup -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/react-big-calendar/1.12.0/addons/dragAndDrop/react-big-calendar-addons-dnd.min.js"></script> -->
    <!-- FileSaver for CSV export -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <!-- jwt-decode for token decoding -->
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@4.0.0/build/jwt-decode.min.js"></script>
    <!-- Babel (MUST be loaded AFTER all libraries it will transform/use) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        /* Custom styles for buttons and elements */
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-success:hover:not(:disabled) {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-warning {
            background-color: #ffc107;
            color: #333;
            padding: 8px 16px;
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-warning:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            background-color: #ffc107;
            color: #333;
        }
        .btn-warning:hover:not(:disabled) {
            background-color: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
            padding: 8px 16px;
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-danger:hover:not(:disabled) {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 8px 16px;
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-dark-toggle {
            background-color: #4b5563;
            color: white;
            padding: 8px 16px;
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-dark-toggle:hover {
            background-color: #374151;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .tabs {
            padding: 10px 20px;
            border-radius: 0.5rem;
            background-color: #e5e7eb;
            color: #374151;
            font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tabs.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        .tabs:hover:not(.active) {
            background-color: #d1d5db;
            transform: translateY(-1px);
        }
        .card {
            background-color: white;
            padding: 24px;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        html.dark .card {
            background-color: #1f2937;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 9999px;
            margin-left: 8px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-badge-present {
            background-color: #10B981; /* Green-500 */
            color: white;
        }
        .status-badge-late {
            background-color: #EF4444; /* Red-500 */
            color: white;
        }
        .status-badge-checked-in {
            background-color: #3B82F6; /* Blue-500 */
            color: white;
        }
        .status-badge-approved {
            background-color: #059669; /* Emerald-600 */
            color: white;
        }
        .status-badge-pending {
            background-color: #FBBF24; /* Yellow-400 */
            color: #333;
        }
        .status-badge-rejected {
            background-color: #B91C1C; /* Red-700 */
            color: white;
        }
        .status-badge-cancellation-pending {
            background-color: #F59E0B; /* Orange-500 */
            color: white;
        }
        .status-badge-cancelled {
            background-color: #6B7280; /* Gray-500 */
            color: white;
            text-decoration: line-through;
        }
        .status-badge-absent {
            background-color: #4B5563; /* Gray-700 */
            color: white;
        }
        /* Custom scrollbar for overflow areas */
        .scrollbar-thin {
            scrollbar-width: thin; /* Firefox */
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px; /* For vertical scrollbar */
            height: 8px; /* For horizontal scrollbar */
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #9CA3AF; /* Gray-400 */
            border-radius: 4px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background-color: #F3F4F6; /* Gray-100 */
            border-radius: 4px;
        }
        html.dark .scrollbar-thin::-webkit-scrollbar-track {
            background-color: #374151; /* Gray-700 */
        }

        /* React Big Calendar specific overrides */
        .rbc-calendar {
            font-family: 'Inter', sans-serif;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            background-color: white;
        }
        html.dark .rbc-calendar {
            background-color: #1f2937; /* dark:bg-gray-800 */
            color: white;
        }
        html.dark .rbc-header {
            color: #d1d5db; /* dark:text-gray-300 */
        }
        html.dark .rbc-toolbar button {
            color: white;
            background-color: #374151; /* dark:bg-gray-700 */
        }
        html.dark .rbc-toolbar button:hover {
            background-color: #4b5563; /* dark:bg-gray-600 */
        }
        html.dark .rbc-day-bg {
            background-color: #374151; /* dark:bg-gray-700 */
        }
        html.dark .rbc-row-segment .rbc-event {
            background-color: #3b82f6; /* dark:bg-blue-500 */
            color: white;
        }
        html.dark .rbc-today {
            background-color: #4f46e5; /* dark:bg-indigo-600 */
        }
        html.dark .rbc-off-range-bg {
            background-color: #1f2937; /* dark:bg-gray-800 */
        }
        html.dark .rbc-current-time-indicator {
            background-color: #ef4444; /* dark:bg-red-500 */
        }
        /* Custom event colors for RBC based on status/type */
        .rbc-event-attendance-present { background-color: #10B981; } /* Green-500 */
        .rbc-event-attendance-late { background-color: #EF4444; } /* Red-500 */
        .rbc-event-attendance-absent { background-color: #4B5563; } /* Gray-700 */
        .rbc-event-attendance-checked-in { background-color: #3B82F6; } /* Blue-500 */

        .rbc-event-leave-pending { background-color: #FBBF24; color: #333; } /* Yellow-400 */
        .rbc-event-leave-approved { background-color: #059669; } /* Emerald-600 */
        .rbc-event-leave-rejected { background-color: #B91C1C; } /* Red-700 */
        .rbc-event-leave-cancellation_pending { background-color: #F59E0B; } /* Orange-500 */
        .rbc-event-leave-cancelled { background-color: #6B7280; text-decoration: line-through; } /* Gray-500 */

        .rbc-event-holiday { background-color: #8B5CF6; } /* Purple-500 */
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // Ensure all ReactBigCalendar components and functions are ready before use.
        // We defer their assignment and the ReactDOM.render call to window.onload.
        let RBCCalendar;
        let RBCMomentLocalizer;
        // Removed RBCWithDragAndDrop as it was causing issues
        let localizer;
        let CalendarComponent; // Renamed from DnDCalendar to reflect removal of D&D

        // Use a fixed API URL for the HTML version
        const API_URL = 'https://hrms-backend-rhsc.onrender.com';

        const axiosInstance = axios.create({
            baseURL: API_URL,
            withCredentials: true,
        });

        axiosInstance.interceptors.request.use(
            (config) => {
                const token = localStorage.getItem('accessToken');
                if (token) {
                    config.headers.Authorization = `Bearer ${token}`;
                }
                return config;
            },
            (error) => Promise.reject(error)
        );

        axiosInstance.interceptors.response.use(
            (response) => response,
            async (error) => {
                const originalRequest = error.config;
                if (error.response?.status === 401 && !originalRequest._retry) {
                    originalRequest._retry = true;
                    try {
                        console.log('Attempting to refresh token...');
                        const { data } = await axiosInstance.post('/auth/refresh');
                        console.log('Token refreshed successfully');
                        localStorage.setItem('accessToken', data.accessToken);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        originalRequest.headers.Authorization = `Bearer ${data.accessToken}`;
                        return axiosInstance(originalRequest);
                    } catch (refreshError) {
                        console.error('Refresh token failed definitively:', {
                            message: refreshError.message,
                            response: refreshError.response?.data,
                            status: refreshError.response?.status,
                        });
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('user');
                        window.location.replace('/');
                        return Promise.reject(refreshError);
                    }
                }
                console.error('API error:', {
                    url: error.config?.url,
                    status: error.response?.status,
                    message: error.response?.data?.message,
                });
                return Promise.reject(error);
            }
        );

        const AuthForms = ({ authView, setToken, setUser, setRole, darkMode, toggleDarkMode }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [name, setName] = useState('');
            const [employeeId, setEmployeeId] = useState('');
            const [roleInput, setRoleInput] = useState('employee');
            const [shiftType, setShiftType] = useState('day');

            const handleLogin = async (e) => {
                e.preventDefault();
                try {
                    const res = await axiosInstance.post('/auth/login', { email, password });
                    localStorage.setItem('accessToken', res.data.accessToken);
                    localStorage.setItem('user', JSON.stringify(res.data.user));
                    setToken(res.data.accessToken);
                    setUser(res.data.user);
                    setRole(res.data.user.role);
                    alert('Login successful!');
                } catch (err) {
                    alert('Login failed: ' + (err.response?.data?.message || err.message));
                }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                try {
                    const res = await axiosInstance.post('/register', { name, email, password, employee_id: employeeId, role: roleInput, shift_type: shiftType });
                    alert('Registration successful! Please login.');
                    setEmail('');
                    setPassword('');
                    setName('');
                    setEmployeeId('');
                    setRoleInput('employee');
                    setShiftType('day');
                } catch (err) {
                    alert('Registration failed: ' + (err.response?.data?.message || err.message));
                }
            };

            const handleResetPassword = async (e) => {
                e.preventDefault();
                try {
                    await axios.post(`${API_URL}/auth/reset-password`, { token: new URLSearchParams(window.location.search).get('token'), newPassword });
                    alert('Password reset successful! Please login.');
                    window.location.href = '/';
                } catch (err) {
                    alert('Reset password failed: ' + (err.response?.data?.message || err.message));
                }
            };

            return (
                <div className={`min-h-screen flex items-center justify-center p-4 ${darkMode ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-900'}`}>
                    <div className="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-xl transform transition-all duration-300 hover:shadow-3xl">
                        <div className="flex justify-end mb-4">
                            <button
                                onClick={toggleDarkMode}
                                className="text-sm text-blue-500 hover:text-blue-600 transition-colors duration-200 font-medium"
                            >
                                Toggle {darkMode ? 'Light' : 'Dark'} Mode
                            </button>
                        </div>
                        {authView === 'login' ? (
                            <>
                                <h2 className="text-3xl font-bold mb-6 text-center text-gray-800 dark:text-white">Welcome Back</h2>
                                <form onSubmit={handleLogin} className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Email</label>
                                        <input
                                            type="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                            placeholder="Enter your email"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Password</label>
                                        <input
                                            type="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                            placeholder="Enter your password"
                                            required
                                        />
                                    </div>
                                    <button
                                        type="submit"
                                        className="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700 transition-all duration-200 font-semibold"
                                    >
                                        Sign In
                                    </button>
                                </form>
                                <p className="mt-4 text-center text-sm text-gray-600 dark:text-gray-400">
                                    Don't have an account?{' '}
                                    <a href="/?view=register" className="text-blue-500 hover:text-blue-600 font-medium transition-colors duration-200">
                                        Register here
                                    </a>
                                </p>
                                <p className="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">
                                    Forgot your password?{' '}
                                    <a href="/?view=resetPassword" className="text-blue-500 hover:text-blue-600 font-medium transition-colors duration-200">
                                        Reset it here
                                    </a>
                                </p>
                            </>
                        ) : authView === 'register' ? (
                            <>
                                <h2 className="text-3xl font-bold mb-6 text-center text-gray-800 dark:text-white">Register New Account</h2>
                                <form onSubmit={handleRegister} className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Name</label>
                                        <input
                                            type="text"
                                            value={name}
                                            onChange={(e) => setName(e.target.value)}
                                            className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                            placeholder="Your Name"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Email</label>
                                        <input
                                            type="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                            placeholder="Your Email"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Password</label>
                                        <input
                                            type="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                            placeholder="Choose a strong password"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Employee ID</label>
                                        <input
                                            type="text"
                                            value={employeeId}
                                            onChange={(e) => setEmployeeId(e.target.value)}
                                            className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                            placeholder="Unique Employee ID"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Role</label>
                                        <select
                                            value={roleInput}
                                            onChange={(e) => setRoleInput(e.target.value)}
                                            className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                            required
                                        >
                                            <option value="employee">Employee</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Shift Type</label>
                                        <select
                                            value={shiftType}
                                            onChange={(e) => setShiftType(e.target.value)}
                                            className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                            required
                                        >
                                            <option value="day">Day Shift</option>
                                            <option value="evening">Evening Shift</option>
                                        </select>
                                    </div>
                                    <button
                                        type="submit"
                                        className="w-full bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 focus:ring-4 focus:ring-green-300 dark:focus:ring-green-700 transition-all duration-200 font-semibold"
                                    >
                                        Register
                                    </button>
                                </form>
                                <p className="mt-4 text-center text-sm text-gray-600 dark:text-gray-400">
                                    Already have an account?{' '}
                                    <a href="/" className="text-blue-500 hover:text-blue-600 font-medium transition-colors duration-200">
                                        Login here
                                    </a>
                                </p>
                            </>
                        ) : (
                            <>
                                <h2 className="text-3xl font-bold mb-6 text-center text-gray-800 dark:text-white">Reset Password</h2>
                                <form onSubmit={handleResetPassword} className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">New Password</label>
                                        <input
                                            type="password"
                                            value={newPassword}
                                            onChange={(e) => setNewPassword(e.target.value)}
                                            className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                            required
                                        />
                                    </div>
                                    <button
                                        type="submit"
                                        className="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 focus:ring-4 focus:ring-300 dark:focus:ring-blue-700 transition-all duration-200 font-semibold"
                                    >
                                        Reset Password
                                    </button>
                                </form>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const LeaveApplicationForm = ({ onApplyLeave, darkMode }) => {
            const [fromDate, setFromDate] = useState('');
            const [toDate, setToDate] = useState('');
            const [reason, setReason] = useState('');
            const [totalDays, setTotalDays] = useState(0);

            useEffect(() => {
                if (fromDate && toDate) {
                    const start = moment(fromDate);
                    const end = moment(toDate);
                    if (end.isSameOrAfter(start)) {
                        setTotalDays(end.diff(start, 'days') + 1);
                    } else {
                        setTotalDays(0);
                    }
                } else {
                    setTotalDays(0);
                }
            }, [fromDate, toDate]);

            const handleSubmit = useCallback((e) => {
                e.preventDefault();
                if (totalDays <= 0) {
                    alert('Please select a valid leave duration (To Date must be on or after From Date).');
                    return;
                }
                onApplyLeave(fromDate, toDate, reason);
                setFromDate('');
                setToDate('');
                setReason('');
                setTotalDays(0);
            }, [fromDate, toDate, reason, onApplyLeave, totalDays]);

            return (
                <form onSubmit={handleSubmit} className="mb-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium mb-1">From Date</label>
                            <input
                                type="date"
                                value={fromDate}
                                onChange={(e) => setFromDate(e.target.value)}
                                className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">To Date</label>
                            <input
                                type="date"
                                value={toDate}
                                onChange={(e) => setToDate(e.target.value)}
                                className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                required
                            />
                        </div>
                    </div>
                    {totalDays > 0 && (
                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                            Total days of leave: <span className="font-semibold">{totalDays}</span>
                        </p>
                    )}
                    <div className="mb-4">
                        <label className="block text-sm font-medium mb-1">Reason</label>
                        <textarea
                            value={reason}
                            onChange={(e) => setReason(e.target.value)}
                            className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                            rows="4"
                            required
                        />
                    </div>
                    <button type="submit" className="bg-green-500 text-white p-2 rounded hover:bg-green-600">
                        Apply Leave
                    </button>
                </form>
            );
        };

        const AdminPanel = ({ allLeaves, allCorrections, handleLeaveApproval, handleCorrectionApproval, allEmployeeAttendance, fetchAllEmployeeAttendance, monthlySummary, fetchAllEmployeeMonthlySummary, darkMode, handleExportAttendance }) => {
            const [selectedDate, setSelectedDate] = useState(moment().tz('Asia/Kolkata').format('YYYY-MM-DD'));
            const [selectedAnalyticsYear, setSelectedAnalyticsYear] = useState(moment().tz('Asia/Kolkata').year());
            const [selectedAnalyticsMonth, setSelectedAnalyticsMonth] = useState(moment().tz('Asia/Kolkata').month() + 1);
            const [exportYear, setExportYear] = useState(moment().tz('Asia/Kolkata').year());
            const [exportMonth, setExportMonth] = useState(moment().tz('Asia/Kolkata').month() + 1);
            const [exportEmployeeId, setExportEmployeeId] = useState('');
            const [exportEmployeeName, setExportEmployeeName] = useState('');

            useEffect(() => {
                fetchAllEmployeeAttendance(selectedDate);
            }, [selectedDate, fetchAllEmployeeAttendance]);

            useEffect(() => {
                fetchAllEmployeeMonthlySummary(selectedAnalyticsYear, selectedAnalyticsMonth);
            }, [selectedAnalyticsYear, selectedAnalyticsMonth, fetchAllEmployeeMonthlySummary]);

            return (
                <div>
                    <h3 className="text-lg mb-3 text-gray-800 dark:text-gray-100">Manage Leaves</h3>
                    <ul className="list-disc pl-5 space-y-2 mb-6 max-h-48 overflow-y-auto scrollbar-thin">
                        {allLeaves.length > 0 ? (
                            allLeaves.map((l, i) => (
                                <li key={i} className="py-1 flex justify-between items-center text-sm text-gray-700 dark:text-gray-300">
                                    <span>
                                        <strong>{l.user_name} ({l.employee_id || 'N/A'})</strong> applied for leave: {moment(l.from_date).tz('Asia/Kolkata').format('YYYY-MM-DD')} to {moment(l.to_date).tz('Asia/Kolkata').format('YYYY-MM-DD')} - {l.reason}
                                        <span className={`status-badge status-badge-${l.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`}>
                                            [{l.status}]
                                        </span>
                                        {l.assigned_admin_name && <span className="ml-2 text-gray-500 dark:text-gray-400"> (Assigned to: {l.assigned_admin_name})</span>}
                                    </span>
                                    {l.status === 'pending' && (
                                        <div>
                                            <button
                                                onClick={() => handleLeaveApproval(l.id, 'approved')}
                                                className="bg-green-500 text-white px-2 py-1 rounded-md mr-2 hover:bg-green-600 transition-colors"
                                            >
                                                Approve
                                            </button>
                                            <button
                                                onClick={() => handleLeaveApproval(l.id, 'rejected')}
                                                className="bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 transition-colors"
                                            >
                                                Reject
                                            </button>
                                        </div>
                                    )}
                                    {l.status === 'cancellation_pending' && (
                                        <div>
                                            <button
                                                onClick={() => handleLeaveApproval(l.id, 'cancellation_approved')}
                                                className="bg-yellow-500 text-white px-2 py-1 rounded-md mr-2 hover:bg-yellow-600 transition-colors"
                                            >
                                                Approve Cancellation
                                            </button>
                                            <button
                                                onClick={() => handleLeaveApproval(l.id, 'cancellation_rejected')}
                                                className="bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 transition-colors"
                                            >
                                                Reject Cancellation
                                            </button>
                                        </div>
                                    )}
                                </li>
                            ))
                        ) : (
                            <p className="text-gray-600 dark:text-gray-400">No leave requests found.</p>
                        )}
                    </ul>
                    <h3 className="text-lg mb-3 text-gray-800 dark:text-gray-100">Manage Correction Requests</h3>
                    <ul className="list-disc pl-5 space-y-2 max-h-48 overflow-y-auto scrollbar-thin">
                        {allCorrections.length > 0 ? (
                            allCorrections.map((c, i) => (
                                <li key={i} className="py-1 flex justify-between items-center text-sm text-gray-700 dark:text-gray-300">
                                    <span>
                                        <strong>{c.user_name} ({c.employee_id || 'N/A'})</strong> requested correction for: {moment(c.date).tz('Asia/Kolkata').format('YYYY-MM-DD')} - {c.reason}
                                        <span className={`status-badge status-badge-${c.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`}>
                                            [{c.status}]
                                        </span>
                                        {c.assigned_admin_name && <span className="ml-2 text-gray-500 dark:text-gray-400"> (Assigned to: {c.assigned_admin_name})</span>}
                                    </span>
                                    {c.status === 'pending' && (
                                        <div>
                                            <button
                                                onClick={() => handleCorrectionApproval(c.id, 'approved')}
                                                className="bg-green-500 text-white px-2 py-1 rounded-md mr-2 hover:bg-green-600 transition-colors"
                                            >
                                                Approve
                                            </button>
                                            <button
                                                onClick={() => handleCorrectionApproval(c.id, 'rejected')}
                                                className="bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 transition-colors"
                                            >
                                                Reject
                                            </button>
                                        </div>
                                    )}
                                </li>
                            ))
                        ) : (
                            <p className="text-gray-600 dark:text-gray-400">No correction requests found.</p>
                        )}
                    </ul>

                    <h3 className="text-lg mt-6 mb-3 text-gray-800 dark:text-gray-100">Daily Employee Attendance Overview</h3>
                    <div className="mb-4">
                        <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Select Date:</label>
                        <input
                            type="date"
                            value={selectedDate}
                            onChange={(e) => setSelectedDate(e.target.value)}
                            className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                        />
                    </div>
                    <div className="overflow-x-auto rounded-lg shadow-md">
                        <table className="min-w-full bg-white dark:bg-gray-800 text-sm">
                            <thead className="bg-blue-600 dark:bg-blue-800 text-white">
                                <tr>
                                    <th className="px-6 py-3 text-left font-semibold">Employee Name</th>
                                    <th className="px-6 py-3 text-left font-semibold">Employee ID</th>
                                    <th className="px-6 py-3 text-left font-semibold">Shift Type</th>
                                    <th className="px-6 py-3 text-left font-semibold">Status</th>
                                    <th className="px-6 py-3 text-left font-semibold">Check-in</th>
                                    <th className="px-6 py-3 text-left font-semibold">Check-out</th>
                                </tr>
                            </thead>
                            <tbody>
                                {allEmployeeAttendance.length > 0 ? (
                                    allEmployeeAttendance.map((emp, index) => (
                                        <tr key={emp.user_id} className={index % 2 === 0 ? 'bg-gray-50 dark:bg-gray-750' : 'bg-white dark:bg-gray-800'}>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.name}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.employee_id}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.shift_type}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className={`status-badge status-badge-${emp.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`}>
                                                    {emp.status || 'N/A'}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.check_in ? moment(emp.check_in, 'HH:mm:ss').format('HH:mm') : 'N/A'}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.check_out ? moment(emp.check_out, 'HH:mm:ss').format('HH:mm') : 'N/A'}</td>
                                        </tr>
                                    ))
                                ) : (
                                    <tr>
                                        <td colSpan="6" className="px-6 py-4 text-center text-gray-600 dark:text-gray-400">No employee attendance data found for this date.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>

                    <h3 className="text-lg mt-6 mb-3 text-gray-800 dark:text-gray-100">Monthly Employee Summary</h3>
                    <div className="flex space-x-4 mb-4">
                        <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Year:</label>
                        <input
                            type="number"
                            value={selectedAnalyticsYear}
                            onChange={(e) => setSelectedAnalyticsYear(parseInt(e.target.value, 10))}
                            className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white w-24"
                            min="2000"
                            max="2099"
                        />
                        <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Month:</label>
                        <input
                            type="number"
                            value={selectedAnalyticsMonth}
                            onChange={(e) => setSelectedAnalyticsMonth(parseInt(e.target.value, 10))}
                            className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white w-24"
                            min="1"
                            max="12"
                        />
                    </div>
                    <div className="overflow-x-auto rounded-lg shadow-md">
                        <table className="min-w-full bg-white dark:bg-gray-800 text-sm">
                            <thead className="bg-blue-600 dark:bg-blue-800 text-white">
                                <tr>
                                    <th className="px-6 py-3 text-left font-semibold">Employee Name</th>
                                    <th className="px-6 py-3 text-left font-semibold">Employee ID</th>
                                    <th className="px-6 py-3 text-left font-semibold">Present Days</th>
                                    <th className="px-6 py-3 text-left font-semibold">Leave Days</th>
                                </tr>
                            </thead>
                            <tbody>
                                {monthlySummary.length > 0 ? (
                                    monthlySummary.map((emp, index) => (
                                        <tr key={emp.user_id} className={index % 2 === 0 ? 'bg-gray-50 dark:bg-gray-750' : 'bg-white dark:bg-gray-800'}>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.name}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.employee_id}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.present_days}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{emp.leave_days}</td>
                                        </tr>
                                    ))
                                ) : (
                                    <tr>
                                        <td colSpan="4" className="px-6 py-4 text-center text-gray-600 dark:text-gray-400">No monthly summary data found for the selected period.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>

                    <h3 className="text-lg mt-6 mb-3 text-gray-800 dark:text-gray-100">Export Attendance Data</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label htmlFor="exportYear" className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Year:</label>
                            <input
                                type="number"
                                value={exportYear}
                                onChange={(e) => setExportYear(parseInt(e.target.value, 10))}
                                placeholder="Year (e.g., 2025)"
                                className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                id="exportYear"
                                min="2000"
                                max="2099"
                            />
                        </div>
                        <div>
                            <label htmlFor="exportMonth" className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Month:</label>
                            <input
                                type="number"
                                value={exportMonth}
                                onChange={(e) => setExportMonth(parseInt(e.target.value, 10))}
                                placeholder="Month (1-12)"
                                className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                id="exportMonth"
                                min="1"
                                max="12"
                            />
                        </div>
                        <div>
                            <label htmlFor="exportEmployeeId" className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Employee ID (Optional):</label>
                            <input
                                type="text"
                                placeholder="Employee ID"
                                className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                value={exportEmployeeId}
                                onChange={(e) => setExportEmployeeId(e.target.value)}
                                id="exportEmployeeId"
                            />
                        </div>
                        <div>
                            <label htmlFor="exportEmployeeName" className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Employee Name (Optional):</label>
                            <input
                                type="text"
                                placeholder="Employee Name"
                                className="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                value={exportEmployeeName}
                                onChange={(e) => setExportEmployeeName(e.target.value)}
                                id="exportEmployeeName"
                            />
                        </div>
                    </div>
                    <button
                        onClick={() => {
                            if (exportYear && exportMonth) {
                                window.saveAs(new Blob([""], {type: "text/csv"}), `attendance_${exportYear}_${exportMonth}.csv`); // Placeholder
                                handleExportAttendance(exportYear, exportMonth, exportEmployeeId, exportEmployeeName);
                            } else {
                                alert('Please enter year and month.');
                            }
                        }}
                        className="btn-primary rounded-md px-4 py-2 hover:shadow-lg transition-shadow duration-200"
                    >
                        Download CSV
                    </button>
                </div>
            );
        };

        const ChangePasswordModal = ({ onClose, onChangePassword, darkMode }) => {
            const [currentPassword, setCurrentPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');

            const handleSubmit = useCallback((e) => {
                e.preventDefault();
                onChangePassword(currentPassword, newPassword);
                setCurrentPassword('');
                setNewPassword('');
            }, [currentPassword, newPassword, onChangePassword]);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className={`bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-sm ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        <h2 className="text-xl font-bold mb-4">Change Password</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-1">Current Password</label>
                                <input
                                    type="password"
                                    value={currentPassword}
                                    onChange={(e) => setCurrentPassword(e.target.value)}
                                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                    required
                                />
                            </div>
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-1">New Password</label>
                                <input
                                    type="password"
                                    value={newPassword}
                                    onChange={(e) => setNewPassword(e.target.value)}
                                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                    required
                                />
                            </div>
                            <div className="flex justify-end space-x-2">
                                <button type="button" onClick={onClose} className="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition-colors">
                                    Cancel
                                </button>
                                <button type="submit" className="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition-colors">
                                    Change Password
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const CorrectionRequestModal = ({ onClose, onSubmit, darkMode }) => {
            const [date, setDate] = useState('');
            const [reason, setReason] = useState('');

            const handleSubmit = useCallback((e) => {
                e.preventDefault();
                onSubmit(date, reason);
                setDate('');
                setReason('');
            }, [date, reason, onSubmit]);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className={`bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-sm ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        <h2 className="text-xl font-bold mb-4">Request Attendance Correction</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-1">Date</label>
                                <input
                                    type="date"
                                    value={date}
                                    onChange={(e) => setDate(e.target.value)}
                                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    required
                                />
                            </div>
                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-1">Reason</label>
                                <textarea
                                    value={reason}
                                    onChange={(e) => setReason(e.target.value)}
                                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white placeholder-gray-400 dark:placeholder-gray-500"
                                    rows="4"
                                    required
                                />
                            </div>
                            <div className="flex justify-end space-x-2">
                                <button type="button" onClick={onClose} className="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition-colors">
                                    Cancel
                                </button>
                                <button type="submit" className="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition-colors">
                                    Submit
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const CancelLeaveModal = ({ onClose, onConfirmCancel, leaveId, darkMode }) => {
            const handleConfirm = useCallback(() => {
                onConfirmCancel(leaveId);
                onClose();
            }, [onConfirmCancel, leaveId, onClose]);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className={`bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-xs ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        <h2 className="text-xl font-bold mb-4">Confirm Cancellation</h2>
                        <p className="mb-6">Are you sure you want to request cancellation for this leave?</p>
                        <div className="flex justify-end space-x-2">
                            <button type="button" onClick={onClose} className="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition-colors">
                                No, Keep It
                            </button>
                            <button type="button" onClick={handleConfirm} className="bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition-colors">
                                Yes, Request Cancellation
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [token, setToken] = useState(localStorage.getItem('accessToken'));
            const [role, setRole] = useState(null);
            const [tab, setTab] = useState('attendance');
            const [attendance, setAttendance] = useState([]);
            const [leaves, setLeaves] = useState([]);
            const [corrections, setCorrections] = useState([]);
            const [calendarEvents, setCalendarEvents] = useState([]);
            const [holidays, setHolidays] = useState([]);
            const [darkMode, setDarkMode] = useState(() => {
                const savedMode = localStorage.getItem('darkMode');
                if (savedMode) {
                    return JSON.parse(savedMode);
                }
                return window.matchMedia('(prefers-color-scheme: dark)').matches;
            });
            const [showChangePasswordModal, setShowChangePasswordModal] = useState(false);
            const [showCorrectionRequestModal, setShowCorrectionRequestModal] = useState(false);
            const [showCancelLeaveModal, setShowCancelLeaveModal] = useState(false);
            const [selectedLeaveToCancel, setSelectedLeaveToCancel] = useState(null);
            const [allLeaves, setAllLeaves] = useState([]);
            const [allCorrections, setAllCorrections] = useState([]);
            const [allEmployeeAttendance, setAllEmployeeAttendance] = useState([]);
            const [monthlySummary, setMonthlySummary] = useState([]);
            const [today, setToday] = useState(window.moment().tz('Asia/Kolkata').format('YYYY-MM-DD'));
            const [user, setUser] = useState(null);
            const [todayAttendance, setTodayAttendance] = useState(null);
            const [isCheckingIn, setIsCheckingIn] = useState(false);
            const [analytics, setAnalytics] = useState({
                presentDays: 0,
                weeklyOffs: 0,
                leavesTaken: 0,
                holidays: 0
            });
            const [selectedMonthForTable, setSelectedMonthForTable] = useState(window.moment().tz('Asia/Kolkata').format('YYYY-MM'));

            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                localStorage.setItem('darkMode', JSON.stringify(darkMode));
            }, [darkMode]);

            const handleLogout = useCallback(async () => {
                try {
                    await axiosInstance.post('/auth/logout');
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('user');
                    setToken(null);
                    setUser(null);
                    setRole(null);
                    setTodayAttendance(null);
                    setAttendance([]);
                    setLeaves([]);
                    setCorrections([]);
                    setCalendarEvents([]);
                    setAllLeaves([]);
                    setAllCorrections([]);
                    setAllEmployeeAttendance([]);
                    setMonthlySummary([]);
                    setHolidays([]);
                    setTab('attendance');
                    setAnalytics({ presentDays: 0, weeklyOffs: 0, leavesTaken: 0, holidays: 0 });
                    alert('Logged out successfully!');
                } catch (err) {
                    console.error('Logout failed:', err);
                    alert('Logout failed: ' + (err.response?.data?.message || err.message));
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('user');
                    setToken(null);
                    setUser(null);
                    setRole(null);
                }
            }, []);

            const fetchAttendance = useCallback(async () => {
                try {
                    const res = await axiosInstance.get(`/attendance`);
                    console.log('Fetched attendance data:', res.data);
                    setAttendance(res.data);
                } catch (err) {
                    console.error('Error fetching attendance:', err);
                    if (err.response?.status === 401) handleLogout();
                }
            }, [handleLogout]);

            const fetchLeaves = useCallback(async () => {
                try {
                    const { data } = await axiosInstance.get('/leaves');
                    setLeaves(data);
                } catch (error) {
                    console.error('Error fetching leaves:', error);
                    if (error.response?.status === 401) handleLogout();
                }
            }, [handleLogout]);

            const fetchHolidays = useCallback(async () => {
                try {
                    const { data } = await axiosInstance.get('/holidays');
                    setHolidays(data);
                }
                catch (error) {
                    console.error('Error fetching holidays:', error);
                    if (error.response?.status === 404) {
                        console.warn('Holidays endpoint not found; using empty holidays list.');
                        setHolidays([]);
                    } else if (error.response?.status === 401) {
                        handleLogout();
                    }
                }
            }, [handleLogout]);

            const fetchCorrections = useCallback(async () => {
                try {
                    const { data } = await axiosInstance.get('/attendance/corrections/user', {
                        withCredentials: true,
                    });
                    console.log('Fetched corrections data:', data);
                    setCorrections(data);
                } catch (error) {
                    console.error('Error fetching corrections:', {
                        message: error.message,
                        status: error.response?.status,
                        data: error.response?.data,
                        url: error.config?.url,
                    });
                    if (error.response?.status === 401) handleLogout();
                }
            }, [handleLogout]);

            const fetchAllAdminLeaves = useCallback(async () => {
                if (user?.role === 'admin') {
                    try {
                        const { data } = await axiosInstance.get('/admin/leaves');
                        setAllLeaves(data);
                    }
                    catch (error) {
                        console.error('Error fetching all admin leaves:', error);
                        if (error.response?.status === 401) handleLogout();
                    }
                }
            }, [user?.role, handleLogout]);

            const fetchAllAdminCorrections = useCallback(async () => {
                if (user?.role === 'admin') {
                    try {
                        const { data } = await axiosInstance.get('/admin/attendance/corrections');
                        setAllCorrections(data);
                    }
                    catch (error) {
                        console.error('Error fetching all admin corrections:', error);
                        if (error.response?.status === 401) handleLogout();
                    }
                }
            }, [user?.role, handleLogout]);

            const fetchAllEmployeeAttendance = useCallback(async (date) => {
                if (user?.role === 'admin') {
                    try {
                        const { data } = await axiosInstance.get(`/admin/attendance/daily?date=${date}`);
                        setAllEmployeeAttendance(data);
                    }
                    catch (error) {
                        console.error('Error fetching all employee daily attendance:', error);
                        if (error.response?.status === 401) handleLogout();
                    }
                }
            }, [user?.role, handleLogout]);

            const fetchAllEmployeeMonthlySummary = useCallback(async (year, month) => {
                if (user?.role === 'admin') {
                    try {
                        const { data } = await axiosInstance.get(`/admin/analytics/monthly-summary?year=${year}&month=${month}`);
                        setMonthlySummary(data);
                    }
                    catch (error) {
                        console.error('Error fetching all employee monthly summary:', error);
                        if (error.response?.status === 401) handleLogout();
                    }
                }
            }, [user?.role, handleLogout]);

            const fetchAllAdminData = useCallback(async () => {
                await Promise.all([
                    fetchAllAdminLeaves(),
                    fetchAllAdminCorrections(),
                    fetchAllEmployeeMonthlySummary(window.moment().tz('Asia/Kolkata').year(), window.moment().tz('Asia/Kolkata').month() + 1)
                ]);
            }, [fetchAllAdminLeaves, fetchAllAdminCorrections, fetchAllEmployeeMonthlySummary]);

            const refreshUserData = useCallback(async () => {
                if (isCheckingIn) {
                    console.log('Skipping refreshUserData during check-in');
                    return;
                }
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) {
                    console.warn('No access token found, skipping attendance fetch and clearing user state.');
                    setUser(null);
                    setRole(null);
                    return;
                }
                try {
                    const todayFormatted = window.moment().tz('Asia/Kolkata').format('YYYY-MM-DD');
                    console.log('Refreshing data for date:', todayFormatted);

                    const res = await axiosInstance.get('/attendance');
                    const allRecords = res.data;
                    console.log('Fetched attendance records:', allRecords);
                    const todayRecord = allRecords.find(a => window.moment(a.date).tz('Asia/Kolkata').format('YYYY-MM-DD') === todayFormatted);
                    console.log('Today\'s attendance record:', todayRecord);
                    setAttendance(allRecords);
                    setTodayAttendance(todayRecord || null);

                    await Promise.all([fetchLeaves(), fetchCorrections(), fetchHolidays()]);
                } catch (error) {
                    console.error('Failed to fetch user data or attendance:', {
                        message: error.message,
                        status: error.response?.status,
                        url: error.config?.url,
                    });
                    if (error.response?.status === 401) {
                        console.warn('Unauthorized during data refresh, logging out.');
                        handleLogout();
                    }
                    setTodayAttendance(null);
                }
            }, [isCheckingIn, fetchLeaves, fetchCorrections, fetchHolidays, handleLogout]);

            const updateAnalytics = useCallback(() => {
                const startOfMonth = window.moment().tz('Asia/Kolkata').startOf('month');
                const endOfMonth = window.moment().tz('Asia/Kolkata').endOf('month');
                let presentDays = 0;
                let weeklyOffs = 0;
                let leavesTaken = 0;
                let holidaysCount = 0;

                presentDays = attendance.filter(a =>
                    window.moment(a.date).tz('Asia/Kolkata').isBetween(startOfMonth, endOfMonth, null, '[]') &&
                    a.status && ['present', 'late'].includes(a.status.toLowerCase())
                ).length;

                let currentDay = startOfMonth.clone();
                while (currentDay.isSameOrBefore(endOfMonth)) {
                    if (currentDay.day() === 0 || currentDay.day() === 6) {
                        const hasAttendance = attendance.some(a =>
                            window.moment(a.date).tz('Asia/Kolkata').format('YYYY-MM-DD') === currentDay.format('YYYY-MM-DD')
                        );
                        if (!hasAttendance) weeklyOffs++;
                    }
                    currentDay.add(1, 'day');
                }

                leaves.filter(l => l.status === 'approved').forEach(l => {
                    const leaveStart = window.moment(l.from_date).tz('Asia/Kolkata');
                    const leaveEnd = window.moment(l.to_date).tz('Asia/Kolkata');

                    const effectiveStart = window.moment.max(leaveStart, startOfMonth);
                    const effectiveEnd = window.moment.min(leaveEnd, endOfMonth);

                    if (effectiveStart.isSameOrBefore(effectiveEnd)) {
                        leavesTaken += effectiveEnd.diff(effectiveStart, 'days') + 1;
                    }
                });

                holidaysCount = holidays.filter(h =>
                    window.moment(h.date).tz('Asia/Kolkata').isBetween(startOfMonth, endOfMonth, null, '[]')
                ).length;

                setAnalytics({
                    presentDays,
                    weeklyOffs,
                    leavesTaken,
                    holidays: holidaysCount
                });
            }, [attendance, leaves, holidays]);

            useEffect(() => {
                updateAnalytics();
            }, [attendance, leaves, holidays, updateAnalytics]);

            useEffect(() => {
                const storedUser = localStorage.getItem('user');
                const storedAccessToken = localStorage.getItem('accessToken');
                if (storedUser && storedAccessToken) {
                    try {
                        const parsedUser = JSON.parse(storedUser);
                        console.log('App.jsx: Loaded user from localStorage (parsed):', parsedUser);
                        setUser(parsedUser);
                        setRole(parsedUser.role);
                        setToken(storedAccessToken);
                        console.log('App.jsx: User state SET from localStorage:', parsedUser.name);
                    } catch (error) {
                        console.error("App.jsx: Failed to parse user data from localStorage:", error);
                        localStorage.removeItem('user');
                        localStorage.removeItem('accessToken');
                        setUser(null);
                        setRole(null);
                        setToken(null);
                    }
                } else {
                    console.log('App.jsx: No user data or token found in localStorage.');
                    setUser(null);
                    setRole(null);
                    setToken(null);
                }
            }, []);

            useEffect(() => {
                if (token && user) {
                    refreshUserData();
                    if (user.role === 'admin') {
                        fetchAllAdminData();
                        fetchAllEmployeeAttendance(window.moment().tz('Asia/Kolkata').format('YYYY-MM-DD'));
                        fetchAllEmployeeMonthlySummary(window.moment().tz('Asia/Kolkata').year(), window.moment().tz('Asia/Kolkata').month() + 1);
                    }
                } else if (!token && !user) {
                    setTodayAttendance(null);
                    setAttendance([]);
                    setLeaves([]);
                    setCorrections([]);
                    setCalendarEvents([]);
                    setAllLeaves([]);
                    setAllCorrections([]);
                    setAllEmployeeAttendance([]);
                    setMonthlySummary([]);
                    setHolidays([]);
                    setAnalytics({ presentDays: 0, weeklyOffs: 0, leavesTaken: 0, holidays: 0 });
                }
            }, [token, user, refreshUserData, fetchAllAdminData, fetchAllEmployeeAttendance, fetchAllEmployeeMonthlySummary]);

            useEffect(() => {
                console.log(' Updated todayAttendance:', todayAttendance);
            }, [todayAttendance]);

            useEffect(() => {
                const interval = setInterval(() => {
                    const newToday = window.moment().tz('Asia/Kolkata').format('YYYY-MM-DD');
                    if (newToday !== today) {
                        console.log('Date changed, refreshing data:', newToday);
                        setToday(newToday);
                        setTodayAttendance(null);
                        refreshUserData();
                        if (user?.role === 'admin') {
                            fetchAllEmployeeAttendance(newToday);
                            fetchAllEmployeeMonthlySummary(window.moment().tz('Asia/Kolkata').year(), window.moment().tz('Asia/Kolkata').month() + 1);
                        }
                    }
                }, 60000);
                return () => clearInterval(interval);
            }, [today, refreshUserData, user?.role, fetchAllEmployeeAttendance, fetchAllEmployeeMonthlySummary]);

            useEffect(() => {
                console.log("--- Generating Calendar Events for react-big-calendar ---");
                const mapped = [
                    ...attendance.map(a => {
                        const startMoment = window.moment.tz(a.date, 'YYYY-MM-DD', 'Asia/Kolkata').startOf('day');
                        const endMoment = startMoment.clone().add(1, 'day');
                        console.log(`  Attendance Event - DB Date: ${a.date}, RBC Start (Date Obj): ${startMoment.toDate()}, RBC End (Date Obj): ${endMoment.toDate()}`);
                        return {
                            id: `attendance-${a.id || Math.random()}`,
                            title: `Check-in: ${a.status ? a.status.toUpperCase() : 'UNKNOWN'} (${a.check_in ? window.moment(a.check_in, 'HH:mm:ss').tz('Asia/Kolkata').format('h:mm A') : 'N/A'} - ${a.check_out ? window.moment(a.check_out, 'HH:mm:ss').tz('Asia/Kolkata').format('h:mm A') : 'N/A'})`,
                            start: startMoment.toDate(),
                            end: endMoment.toDate(),
                            allDay: true,
                            resource: { type: 'attendance', status: a.status }
                        };
                    }),
                    ...leaves.map(l => {
                        const leaveStartMoment = window.moment.tz(l.from_date, 'YYYY-MM-DD', 'Asia/Kolkata').startOf('day');
                        const leaveEndMoment = window.moment.tz(l.to_date, 'YYYY-MM-DD', 'Asia/Kolkata').startOf('day').add(1, 'days');
                        console.log(`  Leave Event - DB From: ${l.from_date}, DB To: ${l.to_date}, RBC Start (Date Obj): ${leaveStartMoment.toDate()}, RBC End (Date Obj): ${leaveEndMoment.toDate()}, Status: ${l.status}`);

                        return {
                            id: `leave-${l.id || Math.random()}`,
                            title: 'Leave',
                            start: leaveStartMoment.toDate(),
                            end: leaveEndMoment.toDate(),
                            allDay: true,
                            resource: { type: 'leave', status: l.status, leaveData: l }
                        };
                    }),
                    ...holidays.map(h => {
                        const holidayStartMoment = window.moment.tz(h.date, 'YYYY-MM-DD', 'Asia/Kolkata').startOf('day');
                        const holidayEndMoment = holidayStartMoment.clone().add(1, 'day');
                        console.log(`  Holiday Event - DB Date: ${h.date}, RBC Start (Date Obj): ${holidayStartMoment.toDate()}, RBC End (Date Obj): ${holidayEndMoment.toDate()}`);
                        return {
                            id: `holiday-${h.id || Math.random()}`,
                            title: `Holiday: ${h.name}`,
                            start: holidayStartMoment.toDate(),
                            end: holidayEndMoment.toDate(),
                            allDay: true,
                            resource: { type: 'holiday' }
                        };
                    })
                ];
                setCalendarEvents(mapped);
                console.log("--- Calendar Events Generation Complete ---");
            }, [attendance, leaves, holidays]);

            const handleCheckIn = useCallback(async () => {
                try {
                    setIsCheckingIn(true);
                    const response = await axiosInstance.post('/attendance/checkin');
                    alert(`Checked in successfully! Status: ${response.data.data.status}`);
                    setTodayAttendance({
                        ...response.data.data,
                        date: window.moment(response.data.data.date).tz('Asia/Kolkata').format('YYYY-MM-DD')
                    });
                    await refreshUserData();
                } catch (err) {
                    console.error('Check-in failed:', err);
                    alert('Check-in failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                } finally {
                    setIsCheckingIn(false);
                }
            }, [refreshUserData, handleLogout]);

            const handleCheckOut = useCallback(async () => {
                try {
                    setIsCheckingIn(true);
                    const response = await axiosInstance.post('/attendance/checkout');
                    alert('Checked out successfully!');
                    setTodayAttendance({
                        ...response.data.data,
                        date: window.moment(response.data.data.date).tz('Asia/Kolkata').format('YYYY-MM-DD')
                    });
                    await refreshUserData();
                } catch (err) {
                    console.error('Check-out failed:', err);
                    alert('Check-out failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                } finally {
                    setIsCheckingIn(false);
                }
            }, [refreshUserData, handleLogout]);

            const handleExportAttendance = useCallback(async (year, month, employeeId = '', employeeName = '') => {
                try {
                    const params = { year, month };
                    let filenameSuffix = '';

                    if (employeeId) {
                        params.employee_id = employeeId;
                        filenameSuffix = `_${employeeId}`;
                    } else if (employeeName) {
                        params.employee_name = employeeName;
                        filenameSuffix = `_${employeeName.replace(/\s/g, '_')}`;
                    }

                    const response = await axiosInstance.get('/admin/attendance/export', {
                        params: params,
                        responseType: 'blob'
                    });
                    window.saveAs(new Blob([response.data], { type: 'text/csv' }), `attendance_${year}_${month}${filenameSuffix}.csv`);
                    alert('Attendance data exported successfully!');
                } catch (err) {
                    console.error('Export failed:', err);
                    alert('Export failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                }
            }, [handleLogout]);

            const refreshAdminData = useCallback(async () => {
                await Promise.all([
                    fetchAllAdminLeaves(),
                    fetchAllAdminCorrections(),
                    fetchAllEmployeeAttendance(window.moment().tz('Asia/Kolkata').format('YYYY-MM-DD')),
                    fetchAllEmployeeMonthlySummary(window.moment().tz('Asia/Kolkata').year(), window.moment().tz('Asia/Kolkata').month() + 1)
                ]);
            }, [fetchAllAdminLeaves, fetchAllAdminCorrections, fetchAllEmployeeAttendance, fetchAllEmployeeMonthlySummary]);

            const handleCorrectionRequest = useCallback(async (date, reason) => {
                try {
                    if (window.moment(date).isAfter(window.moment().tz('Asia/Kolkata'), 'day')) {
                        alert('Attendance correction can only be requested for past or current dates.');
                        return;
                    }
                    await axiosInstance.post('/attendance/correction-request', { date, reason });
                    alert('Correction request submitted!');
                    await refreshUserData();
                    if (user?.role === 'admin') {
                        await fetchAllAdminCorrections();
                    }
                    setShowCorrectionRequestModal(false);
                } catch (err) {
                    console.error('Correction request failed:', err);
                    alert('Correction request failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                }
            }, [refreshUserData, handleLogout, user?.role, fetchAllAdminCorrections]);

            const handleCorrectionApproval = useCallback(async (id, status) => {
                try {
                    await axiosInstance.post('/admin/attendance/correction-review', { id, status });
                    alert(`Correction ID ${id} ${status}!`);
                    await refreshAdminData();
                    await refreshUserData();
                } catch (err) {
                    console.error('Correction review failed:', err);
                    alert('Correction review failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                }
            }, [refreshAdminData, refreshUserData, handleLogout]);

            const handleLeaveApproval = useCallback(async (leave_id, status) => {
                try {
                    if (status === 'approved' || status === 'rejected') {
                        await axiosInstance.post('/admin/leaves/update', { leave_id, status });
                        alert(`Leave ID ${leave_id} ${status}!`);
                    } else if (status === 'cancellation_approved' || status === 'cancellation_rejected') {
                        await axiosInstance.post('/admin/leaves/update-cancellation', { leave_id, status });
                        alert(`Leave ID ${leave_id} cancellation ${status.replace('cancellation_', '')}!`);
                    } else {
                        alert('Invalid leave status provided.');
                        return;
                    }
                    await refreshAdminData();
                    await refreshUserData();
                } catch (err) {
                    console.error('Leave update failed:', err);
                    alert('Leave update failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                }
            }, [refreshAdminData, refreshUserData, handleLogout]);

            const handleApplyLeave = useCallback(async (from_date, to_date, reason) => {
                try {
                    console.log('Submitting leave application:', { from_date, to_date, reason });
                    await axiosInstance.post('/leaves/apply', { from_date, to_date, reason });
                    alert('Leave application submitted!');
                    await refreshUserData();
                } catch (err) {
                    console.error('Leave application failed:', err);
                    alert('Leave application failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                }
            }, [refreshUserData, handleLogout]);

            const handleCancelLeaveRequest = useCallback(async (leaveId) => {
                try {
                    console.log(`Requesting cancellation for leave ID: ${leaveId}`);
                    await axiosInstance.post('/leaves/cancel-request', { leave_id: leaveId });
                    alert('Leave cancellation request submitted successfully!');
                    await refreshUserData();
                    setShowCancelLeaveModal(false);
                    setSelectedLeaveToCancel(null);
                } catch (err) {
                    console.error('Leave cancellation request failed:', err);
                    alert('Leave cancellation request failed: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                } finally {
                    setShowCancelLeaveModal(false);
                    setSelectedLeaveToCancel(null);
                }
            }, [refreshUserData, handleLogout]);

            const handleChangePassword = useCallback(async (currentPassword, newPassword) => {
                try {
                    const res = await axiosInstance.post('/auth/change-password', { currentPassword, newPassword });
                    alert(res.data.message);
                    setShowChangePasswordModal(false);
                } catch (err) {
                    console.error('Change password failed:', err.response?.data?.message || err.message);
                    alert('Change password failed: ' + (err.response?.data?.message || 'Please check your current password.'));
                    if (err.response?.status === 401) handleLogout();
                }
            }, [handleLogout]);

            const toggleDarkMode = useCallback(() => setDarkMode(prev => !prev), []);

            const handleEventDrop = useCallback(async ({ event, start, end }) => {
                // This function is no longer called by the calendar due to D&D removal
                // Kept for reference or if D&D is re-introduced with a different setup.
                if (event.resource.type === 'attendance' || event.resource.type === 'holiday') {
                    alert('Cannot modify attendance or holiday events.');
                    return;
                }
                if (event.resource.type === 'leave' && event.resource.status !== 'approved') {
                    alert('Only approved leaves can be modified via drag and drop.');
                    return;
                }

                try {
                    const actualEndDateMoment = window.moment(end).subtract(1, 'day');

                    if (window.moment(start).isAfter(actualEndDateMoment)) {
                        alert('Start date cannot be after end date.');
                        await refreshUserData();
                        return;
                    }

                    const newFromDate = window.moment(start).format('YYYY-MM-DD');
                    const newToDate = actualEndDateMoment.format('YYYY-MM-DD');

                    const updatedEvent = {
                        ...event,
                        start: window.moment.tz(newFromDate, 'YYYY-MM-DD', 'Asia/Kolkata').startOf('day').toDate(),
                        end: window.moment.tz(newToDate, 'YYYY-MM-DD', 'Asia/Kolkata').add(1, 'day').startOf('day').toDate(),
                    };

                    await axiosInstance.put(`/leaves/${event.resource.leaveData.id}`, {
                        from_date: newFromDate,
                        to_date: newToDate,
                    });
                    setCalendarEvents(prev =>
                        prev.map(evt => (evt.id === event.id ? updatedEvent : evt))
                    );
                    alert('Leave event updated successfully!');
                    await refreshUserData();
                } catch (err) {
                    console.error('Event update failed:', err);
                    alert('Failed to update event: ' + (err.response?.data?.message || err.message));
                    if (err.response?.status === 401) handleLogout();
                    await refreshUserData();
                }
            }, [refreshUserData, handleLogout]);

            const handleSelectSlot = useCallback(async ({ start }) => {
                if (user?.role !== 'admin') {
                    alert('Only admins can add leaves directly from the calendar.');
                    return;
                }
                const reason = prompt('Enter leave reason:');
                if (reason) {
                    await handleApplyLeave(
                        window.moment(start).tz('Asia/Kolkata').format('YYYY-MM-DD'),
                        window.moment(start).tz('Asia/Kolkata').format('YYYY-MM-DD'),
                        reason
                    );
                }
            }, [user?.role, handleApplyLeave]);

            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('token');
            const authView = urlParams.get('view') === 'resetPassword' && resetToken
                ? 'resetPassword'
                : (urlParams.get('view') === 'register' ? 'register' : 'login');

            const userMonthlyAttendance = useMemo(() => {
                const data = [];
                const [year, month] = selectedMonthForTable.split('-').map(Number);
                const startOfMonth = window.moment.tz([year, month - 1, 1], 'Asia/Kolkata').startOf('month');
                const endOfMonth = window.moment.tz([year, month - 1, 1], 'Asia/Kolkata').endOf('month');
                // Ensure expectedCheckinTime is always based on 'Asia/Kolkata' timezone
                const expectedCheckinTime = user?.shift_type === 'evening'
                    ? window.moment().tz('Asia/Kolkata').hour(21).minute(0).second(0) // 9 PM IST
                    : window.moment().tz('Asia/Kolkata').hour(9).minute(0).second(0);   // 9 AM IST

                let currentDay = startOfMonth.clone();
                while (currentDay.isSameOrBefore(endOfMonth)) {
                    const dateFormatted = currentDay.format('YYYY-MM-DD');
                    const dayOfWeek = currentDay.format('dddd');
                    let status = 'Absent';
                    let checkIn = 'N/A';
                    let checkOut = 'N/A';
                    let lateTime = '0m';
                    let workingHours = '0h 0m';
                    let extraHours = '0h 0m';
                    let rowClass = '';

                    const attendanceRecord = attendance.find(a => window.moment(a.date).tz('Asia/Kolkata').format('YYYY-MM-DD') === dateFormatted);
                    const leaveRecord = leaves.find(l =>
                        l.status === 'approved' &&
                        window.moment(dateFormatted).isBetween(window.moment(l.from_date).tz('Asia/Kolkata'), window.moment(l.to_date).tz('Asia/Kolkata'), null, '[]')
                    );
                    const holidayRecord = holidays.find(h => window.moment(h.date).tz('Asia/Kolkata').format('YYYY-MM-DD') === dateFormatted);

                    if (holidayRecord) {
                        status = `Holiday: ${holidayRecord.name}`;
                        rowClass = 'bg-purple-100 dark:bg-purple-800';
                    } else if (leaveRecord) {
                        status = `On Leave: ${leaveRecord.reason}`;
                        rowClass = 'bg-yellow-100 dark:bg-yellow-800';
                    } else if (currentDay.day() === 0 || currentDay.day() === 6) {
                        status = 'Weekly Off (WO)';
                        rowClass = 'bg-blue-100 dark:bg-blue-800';
                    }

                    if (attendanceRecord) {
                        checkIn = attendanceRecord.check_in ? window.moment(attendanceRecord.check_in, 'HH:mm:ss').format('HH:mm A') : 'N/A';
                        checkOut = attendanceRecord.check_out ? window.moment(attendanceRecord.check_out, 'HH:mm:ss').format('HH:mm A') : 'N/A';
                        status = attendanceRecord.status === 'present' ? 'Present' : (attendanceRecord.status === 'late' ? 'Late' : attendanceRecord.status);
                        rowClass = attendanceRecord.status === 'late' ? 'bg-red-100 dark:bg-red-800' : (status === 'present' ? 'bg-green-100 dark:bg-green-800' : rowClass);

                        if (attendanceRecord.check_in) {
                            const actualCheckIn = window.moment(attendanceRecord.check_in, 'HH:mm:ss');
                            if (actualCheckIn.isAfter(expectedCheckinTime)) {
                                const diffMinutes = actualCheckIn.diff(expectedCheckinTime, 'minutes');
                                if (diffMinutes > 0) {
                                    lateTime = `${diffMinutes}m`;
                                }
                            }
                        }

                        if (attendanceRecord.check_in && attendanceRecord.check_out) {
                            const checkInMoment = window.moment(attendanceRecord.check_in, 'HH:mm:ss');
                            const checkOutMoment = window.moment(attendanceRecord.check_out, 'HH:mm:ss');

                            let totalDuration = window.moment.duration(checkOutMoment.diff(checkInMoment));
                            if (checkInMoment.isAfter(checkOutMoment) && user?.shift_type === 'evening') {
                                totalDuration = window.moment.duration(checkOutMoment.add(1, 'day').diff(checkInMoment));
                            } else if (checkInMoment.isAfter(checkOutMoment)) {
                                totalDuration = window.moment.duration(0);
                            }

                            const standardWorkingHours = 8 * 60;
                            let totalMinutes = totalDuration.asMinutes();
                            let calculatedWorkingHours = Math.floor(totalMinutes / 60);
                            let calculatedWorkingMinutes = Math.round(totalMinutes % 60);

                            workingHours = `${calculatedWorkingHours}h ${calculatedWorkingMinutes}m`;

                            if (totalMinutes > standardWorkingHours) {
                                const extraMinutes = totalMinutes - standardWorkingHours;
                                extraHours = `${Math.floor(extraMinutes / 60)}h ${Math.round(extraMinutes % 60)}m`;
                            }
                        }
                    }

                    data.push({
                        date: dateFormatted,
                        dayOfWeek,
                        shift: user?.shift_type || 'N/A',
                        checkIn,
                        checkOut,
                        lateTime,
                        workingHours,
                        extraHours,
                        status,
                        rowClass,
                    });
                    currentDay.add(1, 'day');
                }
                return data;
            }, [selectedMonthForTable, attendance, leaves, holidays, user]);


            if (!token) {
                return <AuthForms authView={authView} setToken={setToken} setUser={setUser} setRole={setRole} darkMode={darkMode} toggleDarkMode={toggleDarkMode} />;
            }

            return (
                <div className={`min-h-screen font-sans ${darkMode ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-900'} p-6 transition-colors duration-300`}>
                    <div className="max-w-7xl mx-auto text-center py-8">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-10 p-4 bg-gradient-to-r from-blue-500 to-purple-600 dark:from-blue-800 dark:to-purple-900 text-white rounded-xl shadow-lg">
                            <div>
                                <h1 className="text-4xl font-extrabold mb-2 leading-tight">
                                     Welcome to HRMS, {user?.name || 'User'}!
                                </h1>
                                <p className="text-xl font-light opacity-90">
                                    You are logged in as <span className="font-semibold">{role}</span>. Shift: <span className="font-semibold">{user?.shift_type || 'day'}</span> {user?.employee_id && `(Employee ID: ${user.employee_id})`}
                                </p>
                            </div>
                            <div className="flex space-x-3 mt-4 md:mt-0">
                                <button
                                    onClick={() => setShowChangePasswordModal(true)}
                                    className="bg-white text-blue-600 px-5 py-2 rounded-lg shadow-md hover:bg-blue-50 transition-all duration-200 font-semibold"
                                >
                                    Change Password
                                </button>
                                <button
                                    onClick={handleLogout}
                                    className="bg-red-400 text-white px-5 py-2 rounded-lg shadow-md hover:bg-red-500 transition-all duration-200 font-semibold"
                                >
                                    Logout
                                </button>
                            </div>
                        </div>

                        <button
                            onClick={toggleDarkMode}
                            className="btn-dark-toggle mb-8 text-lg"
                        >
                            Toggle {darkMode ? 'Light' : 'Dark'} Mode
                        </button>

                        <div className="flex flex-wrap justify-center space-x-3 mb-8">
                            <button
                                onClick={() => setTab('attendance')}
                                className={`tabs ${tab === 'attendance' ? 'active' : ''}`}
                            >
                                Attendance
                            </button>
                            <button
                                onClick={() => setTab('leaves')}
                                className={`tabs ${tab === 'leaves' ? 'active' : ''}`}
                            >
                                Leaves
                            </button>
                            <button
                                onClick={() => setTab('calendar')}
                                className={`tabs ${tab === 'calendar' ? 'active' : ''}`}
                            >
                                Calendar
                            </button>
                            <button
                                onClick={() => setTab('analytics')}
                                className={`tabs ${tab === 'analytics' ? 'active' : ''}`}
                            >
                                Analytics
                            </button>
                            {role === 'admin' && (
                                <button
                                    onClick={() => { setTab('admin'); refreshAdminData(); }}
                                    className={`tabs ${tab === 'admin' ? 'active' : ''}`}
                                >
                                    Admin Panel
                                </button>
                            )}
                        </div>

                        {console.log(" todayAttendance:", todayAttendance)}
                        {tab === 'attendance' && (
                            <div className="card text-left">
                                <h2 className="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Attendance Actions</h2>
                                <p className="mb-6 text-lg font-medium text-gray-700 dark:text-gray-300">
                                    Expected check-in: {user?.shift_type === 'evening' ? '9:00 PM IST' : '9:00 AM IST'}
                                </p>
                                <div className="flex space-x-4 mb-8 flex-wrap gap-y-3">
                                    <button
                                        onClick={handleCheckIn}
                                        className="btn-success text-lg flex-1 md:flex-none"
                                        disabled={!!todayAttendance?.check_in || isCheckingIn}
                                    >
                                        {todayAttendance?.check_in ? 'Already Checked In' : 'Check In'}
                                    </button>
                                    <button
                                        onClick={handleCheckOut}
                                        className="btn-warning text-lg flex-1 md:flex-none"
                                        disabled={
                                            !todayAttendance ||
                                            todayAttendance.check_in === null ||
                                            todayAttendance.check_out !== null ||
                                            isCheckingIn
                                        }
                                        title={
                                            !todayAttendance?.check_in
                                                ? "You must check in before checking out."
                                                : todayAttendance?.check_out
                                                    ? "You have already checked out today."
                                                    : ""
                                        }
                                    >
                                        Check Out
                                    </button>
                                </div>

                                <h3 className="text-xl font-semibold mt-8 mb-4 text-gray-800 dark:text-gray-100">Monthly Attendance Overview</h3>
                                <div className="mb-6">
                                    <label htmlFor="monthPicker" className="block text-md font-medium mb-2 text-gray-700 dark:text-gray-300">Select Month:</label>
                                    <input
                                        type="month"
                                        id="monthPicker"
                                        value={selectedMonthForTable}
                                        onChange={(e) => setSelectedMonthForTable(e.target.value)}
                                        className="p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-blue-500 focus:border-blue-500 transition-all"
                                    />
                                </div>
                                <div className="overflow-x-auto rounded-xl shadow-lg">
                                    <table className="min-w-full bg-white dark:bg-gray-800 text-sm">
                                        <thead className="bg-blue-600 dark:bg-blue-800 text-white">
                                            <tr>
                                                <th className="px-6 py-3 text-left font-semibold">Date</th>
                                                <th className="px-6 py-3 text-left font-semibold">Day</th>
                                                <th className="px-6 py-3 text-left font-semibold">Shift</th>
                                                <th className="px-6 py-3 text-left font-semibold">Check-in</th>
                                                <th className="px-6 py-3 text-left font-semibold">Check-out</th>
                                                <th className="px-6 py-3 text-left font-semibold">Late Time</th>
                                                <th className="px-6 py-3 text-left font-semibold">Working Hours</th>
                                                <th className="px-6 py-3 text-left font-semibold">Extra Hours</th>
                                                <th className="px-6 py-3 text-left font-semibold">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {userMonthlyAttendance.length > 0 ? (
                                                userMonthlyAttendance.map((day, index) => (
                                                    <tr key={day.date} className={`${index % 2 === 0 ? 'bg-gray-50 dark:bg-gray-750' : 'bg-white dark:bg-gray-800'} ${day.rowClass} hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150`}>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.date}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.dayOfWeek}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.shift}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.checkIn}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.checkOut}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.lateTime}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.workingHours}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-gray-700 dark:text-gray-300">{day.extraHours}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap">
                                                            <span className={`status-badge status-badge-${day.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`}>
                                                                {day.status}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))
                                            ) : (
                                                <tr>
                                                    <td colSpan="9" className="px-6 py-4 text-center text-gray-600 dark:text-gray-400">No attendance data found for this month.</td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>

                                <h3 className="text-xl font-semibold mt-8 mb-4 text-gray-800 dark:text-gray-100">Request Attendance Correction</h3>
                                <button
                                    onClick={() => setShowCorrectionRequestModal(true)}
                                    className="btn-secondary text-lg px-6 py-3 rounded-md hover:shadow-lg transition-shadow duration-200"
                                >
                                    Request Correction
                                </button>

                                <h3 className="text-xl font-semibold mt-8 mb-4 text-gray-800 dark:text-gray-100">Your Correction Requests History</h3>
                                <ul className="list-disc pl-5 space-y-3 scrollbar-thin max-h-96 overflow-y-auto pr-2">
                                    {corrections.length > 0 ? (
                                        corrections.map((c, idx) => (
                                            <li key={idx} className="py-2 text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-gray-700 last:border-b-0">
                                                <span className="font-medium">{window.moment(c.date).tz('Asia/Kolkata').format('YYYY-MM-DD')}</span>: {c.reason}
                                                <span className={`status-badge status-badge-${c.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`}>
                                                    [{c.status}]
                                                </span>
                                            </li>
                                        ))
                                    ) : (
                                        <p className="text-gray-600 dark:text-gray-400">No correction requests found.</p>
                                    )}
                                </ul>
                            </div>
                        )}

                        {tab === 'leaves' && (
                            <div className="card text-left">
                                <h2 className="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Apply for Leave</h2>
                                <LeaveApplicationForm onApplyLeave={handleApplyLeave} darkMode={darkMode} />
                                <h3 className="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Your Leave Applications</h3>
                                <ul className="list-disc pl-5 space-y-3 scrollbar-thin max-h-96 overflow-y-auto pr-2">
                                    {leaves.length > 0 ? (
                                        leaves.map((l, i) => {
                                            const isFutureApprovedLeave = l.status === 'approved' && window.moment(l.from_date).isAfter(window.moment().tz('Asia/Kolkata'), 'day');
                                            return (
                                                <li key={i} className="py-2 flex flex-col sm:flex-row justify-between items-start sm:items-center text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-gray-700 last:border-b-0">
                                                    <span className="mb-2 sm:mb-0">
                                                        <span className="font-medium">{window.moment(l.from_date).tz('Asia/Kolkata').format('YYYY-MM-DD')} to {window.moment(l.to_date).tz('Asia/Kolkata').format('YYYY-MM-DD')}</span>: {l.reason}
                                                        <span className={`status-badge status-badge-${l.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`}>
                                                            [{l.status}]
                                                        </span>
                                                    </span>
                                                    {isFutureApprovedLeave && (
                                                        <button
                                                            onClick={() => {
                                                                setSelectedLeaveToCancel(l.id);
                                                                setShowCancelLeaveModal(true);
                                                            }}
                                                            className="bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600 text-sm transition-colors duration-200"
                                                        >
                                                            Request Cancellation
                                                        </button>
                                                    )}
                                                </li>
                                            );
                                        })
                                    ) : (
                                        <p className="text-gray-600 dark:text-gray-400">No leave applications found.</p>
                                    )}
                                </ul>
                            </div>
                        )}

                        {tab === 'calendar' && (
                            <div className="card text-left">
                                <h2 className="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Interactive Calendar</h2>
                                {localizer && CalendarComponent ? (
                                    <CalendarComponent // Changed from DnDCalendar
                                        localizer={localizer}
                                        events={calendarEvents}
                                        selectable
                                        onSelectSlot={handleSelectSlot}
                                        startAccessor="start"
                                        endAccessor="end"
                                        className="rbc-calendar bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner"
                                        defaultView="month"
                                        views={['month', 'week', 'day']}
                                        eventPropGetter={(event) => {
                                            let className = '';
                                            if (event.resource) {
                                                if (event.resource.type === 'attendance') {
                                                    className = `rbc-event-attendance-${event.resource.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`;
                                                } else if (event.resource.type === 'leave') {
                                                    className = `rbc-event-leave-${event.resource.status?.toLowerCase().replace(/\s/g, '-') || 'unknown'}`;
                                                } else if (event.resource.type === 'holiday') {
                                                    className = 'rbc-event-holiday';
                                                }
                                            }
                                            return { className };
                                        }}
                                        // Removed onEventDrop and resizable as D&D is removed
                                        // onEventDrop={handleEventDrop}
                                        // resizable
                                        style={{ height: 600 }}
                                    />
                                ) : (
                                    <p className="text-red-500 text-center">Calendar components not loaded. Please ensure CDN scripts are correctly loaded.</p>
                                )}
                            </div>
                        )}

                        {tab === 'analytics' && (
                            <div className="card text-left">
                                <h2 className="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Monthly Attendance Analytics</h2>
                                <p className="mb-6 text-lg font-medium text-gray-700 dark:text-gray-300">For {window.moment(selectedMonthForTable).tz('Asia/Kolkata').format('MMMMEEEE')}</p>
                                <ul className="list-disc pl-5 space-y-3 text-lg text-gray-700 dark:text-gray-300">
                                    <li className="flex justify-between items-center py-1">
                                        <span>Days Present:</span> <span className="font-semibold text-green-600 dark:text-green-400">{analytics.presentDays}</span>
                                    </li>
                                    <li className="flex justify-between items-center py-1">
                                        <span>Weekly Offs (Sat/Sun, no check-in):</span> <span className="font-semibold text-blue-600 dark:text-blue-400">{analytics.weeklyOffs}</span>
                                    </li>
                                    <li className="flex justify-between items-center py-1">
                                        <span>Leaves Taken:</span> <span className="font-semibold text-yellow-600 dark:text-yellow-400">{analytics.leavesTaken}</span>
                                    </li>
                                    <li className="flex justify-between items-center py-1">
                                        <span>Holidays:</span> <span className="font-semibold text-purple-600 dark:text-purple-400">{analytics.holidays}</span>
                                    </li>
                                </ul>
                            </div>
                        )}

                        {role === 'admin' && tab === 'admin' && (
                            <div className="card text-left">
                                <h2 className="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Admin Panel</h2>
                                <AdminPanel
                                    allLeaves={allLeaves}
                                    allCorrections={allCorrections}
                                    handleLeaveApproval={handleLeaveApproval}
                                    handleCorrectionApproval={handleCorrectionApproval}
                                    allEmployeeAttendance={allEmployeeAttendance}
                                    fetchAllEmployeeAttendance={fetchAllEmployeeAttendance}
                                    monthlySummary={monthlySummary}
                                    fetchAllEmployeeMonthlySummary={fetchAllEmployeeMonthlySummary}
                                    darkMode={darkMode}
                                    handleExportAttendance={handleExportAttendance}
                                />
                            </div>
                        )}

                        {showChangePasswordModal && (
                            <ChangePasswordModal
                                onClose={() => setShowChangePasswordModal(false)}
                                onChangePassword={handleChangePassword}
                                darkMode={darkMode}
                            />
                        )}

                        {showCorrectionRequestModal && (
                            <CorrectionRequestModal
                                onClose={() => setShowCorrectionRequestModal(false)}
                                onSubmit={handleCorrectionRequest}
                                darkMode={darkMode}
                            />
                        )}

                        {showCancelLeaveModal && (
                            <CancelLeaveModal
                                onClose={() => {
                                    setShowCancelLeaveModal(false);
                                    setSelectedLeaveToCancel(null);
                                }}
                                onConfirmCancel={handleCancelLeaveRequest}
                                leaveId={selectedLeaveToCancel}
                                darkMode={darkMode}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // Defer rendering until window is fully loaded to ensure all CDNs are ready
        window.onload = function() {
            // Assign global objects once all scripts are loaded
            RBCCalendar = window.ReactBigCalendar.Calendar;
            RBCMomentLocalizer = window.ReactBigCalendar.momentLocalizer;

            // Removed RBCWithDragAndDrop as it was causing issues.
            // If drag-and-drop functionality is critical, a proper React build environment
            // with npm/yarn and module imports would be necessary.

            // Check if essential components are loaded before proceeding
            if (!RBCCalendar || !RBCMomentLocalizer) {
                console.error("Error: Required React Big Calendar components (Calendar or MomentLocalizer) could not be found. Please check CDN links and network status.");
                // Display a user-friendly error message on the page
                const rootDiv = document.getElementById('root');
                if (rootDiv) {
                    rootDiv.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; font-family: \'Inter\', sans-serif; background-color: #f3f4f6; color: #ef4444; font-size: 1.25rem; text-align: center; padding: 20px;">' +
                                        'Failed to load the calendar. Some essential components are missing. <br/> Please ensure your internet connection is stable and try again.' +
                                        '</div>';
                }
                return; // Stop further execution
            }

            localizer = RBCMomentLocalizer(window.moment);
            CalendarComponent = RBCCalendar; // Use the standard Calendar component

            // Render the App component into the root div
            ReactDOM.render(<App />, document.getElementById('root'));
        };
    </script>
</body>
</html>
